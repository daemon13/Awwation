(function(){if(!window.svgEditor){window["svgEditor"]=function($){var svgCanvas;var Editor={};var is_ready=false;var defaultPrefs={lang:"en",bkgd_color:"#FFF",img_save:"embed"},curPrefs={},curConfig={canvas_expansion:1.5,dimensions:[640,480],initFill:{color:"4a90d6",opacity:1},initStroke:{width:2,color:"222222",opacity:1},initOpacity:1,pasteType:"in_place",imgPath:"images/",langPath:"locale/",extPath:"extensions/",jGraduatePath:"jgraduate/images/",extensions:["ext-grid.js"],initTool:"fhpath",wireframe:false,colorPickerCSS:null,gridSnapping:false,baseUnit:"px",snappingStep:10,showRulers:false,selectNew:false},uiStrings=Editor.uiStrings={common:{"ok":"OK","cancel":"Cancel","key_up":"Up","key_down":"Down","key_backspace":"Backspace","key_del":"Del"},layers:{"layer":"Layer"},notification:{"invalidAttrValGiven":"Invalid value given","noContentToFitTo":"No content to fit to","dupeLayerName":"There is already a layer named that!","enterUniqueLayerName":"Please enter a unique layer name","enterNewLayerName":"Please enter the new layer name","layerHasThatName":"Layer already has that name","QmoveElemsToLayer":'Move selected elements to layer "%s"?',"QwantToClear":"Do you want to clear the drawing?\nThis will also erase your undo history!","QwantToOpen":"Do you want to open a new file?\nThis will also erase your undo history!","QerrorsRevertToSource":"There were parsing errors in your SVG source.\nRevert back to original SVG source?","QignoreSourceChanges":"Ignore changes made to SVG source?","featNotSupported":"Feature not supported","enterNewImgURL":"Enter the new image URL","defsFailOnSave":"NOTE: Due to a bug in your browser, this image may appear wrong (missing gradients or elements). It will however appear correct once actually saved.","loadingImage":"Loading image, please wait...","saveFromBrowser":'Select "Save As..." in your browser to save this image as a %s file.',"noteTheseIssues":"Also note the following issues: ","unsavedChanges":"There are unsaved changes.","enterNewLinkURL":"Enter the new hyperlink URL","errorLoadingSVG":"Error: Unable to load SVG data","URLloadFail":"Unable to load from URL","retrieving":'Retrieving "%s" ...'}};var curPrefs={};var customHandlers={};Editor.curConfig=curConfig;Editor.tool_scale=1;$.pref=function(key,val){if(val){curPrefs[key]=val}key="svg-edit-"+key;var host=location.hostname,onweb=host&&host.indexOf(".")>=0,store=(val!=undefined),storage=false;try{if(window.localStorage){storage=localStorage}}catch(e){}try{if(window.globalStorage&&onweb){storage=globalStorage[host]}}catch(e){}if(storage){if(store){storage.setItem(key,val)}else{if(storage.getItem(key)){return storage.getItem(key)+""}}}else{if(window.widget){if(store){widget.setPreferenceForKey(val,key)}else{return widget.preferenceForKey(key)}}else{if(store){var d=new Date();d.setTime(d.getTime()+31536000000);val=encodeURIComponent(val);document.cookie=key+"="+val+"; expires="+d.toUTCString()}else{var result=document.cookie.match(new RegExp(key+"=([^;]+)"));return result?decodeURIComponent(result[1]):""}}}};Editor.setConfig=function(opts){$.each(opts,function(key,val){if(key in defaultPrefs){$.pref(key,val)}});$.extend(true,curConfig,opts);if(opts.extensions){curConfig.extensions=opts.extensions}};Editor.setCustomHandlers=function(opts){Editor.ready(function(){if(opts.open){$('#tool_open > input[type="file"]').remove();$("#tool_open").show();svgCanvas.open=opts.open}if(opts.save){show_save_warning=false;svgCanvas.bind("saved",opts.save)}if(opts.pngsave){svgCanvas.bind("exported",opts.pngsave)}customHandlers=opts})};Editor.randomizeIds=function(){svgCanvas.randomizeIds(arguments)};Editor.init=function(){(function(){var w=window.opener;if(w){try{var svgEditorReadyEvent=w.document.createEvent("Event");svgEditorReadyEvent.initEvent("svgEditorReady",true,true);w.document.documentElement.dispatchEvent(svgEditorReadyEvent)}catch(e){}}})();(function(){var urldata=$.deparam.querystring(true);if(!$.isEmptyObject(urldata)){$.jGrowl("Opening "+urldata.url);if(urldata.dimensions){urldata.dimensions=urldata.dimensions.split(",")}if(urldata.extensions){urldata.extensions=urldata.extensions.split(",")}Editor.setConfig(urldata);var src=urldata.source;var qstr=$.param.querystring();if(!src){if(qstr.indexOf("source=data:")>=0){src=qstr.match(/source=(data:[^&]*)/)[1]}}if(src){if(src.indexOf("data:")===0){src=src.replace(/ /g,"+");Editor.loadFromDataURI(src)}else{Editor.loadFromString(src)}}else{if(qstr.indexOf("paramurl=")!==-1){Editor.loadFromURL(qstr.substr(9))}else{if(urldata.url){Editor.loadFromURL(urldata.url)}}}}})();var extFunc=function(){$.each(curConfig.extensions,function(){var extname=this;$.getScript(curConfig.extPath+extname,function(d){if(!d){var s=document.createElement("script");s.src=curConfig.extPath+extname;document.querySelector("head").appendChild(s)}})});var good_langs=[];$("#lang_select option").each(function(){good_langs.push(this.value)})};if(document.location.protocol==="file:"){setTimeout(extFunc,100)}else{extFunc()}$.svgIcons(curConfig.imgPath+"svg_edit_icons.svg",{w:22,h:22,id_match:false,no_img:!svgedit.browser.isWebkit(),fallback_path:curConfig.imgPath,fallback:{},placement:{"#tool_clear div,#layer_new":"new_image","#tool_save_cloud div":"save","#tool_save div":"menu_placeholder","#tool_save_as_cloud div":"menu_placeholder","#tool_publish div":"menu_placeholder","#tool_gallery div":"menu_placeholder","#tool_export div":"export","#tool_open_cloud div":"open","#tool_logout div":"menu_placeholder","#tool_new_file div":"menu_placeholder","#tool_open div div":"menu_placeholder","#tool_open_url div div":"menu_placeholder","#tool_import div div":"menu_placeholder","#tool_source":"source","#tool_docprops > div":"menu_placeholder","#tool_wireframe":"wireframe","#tool_undo":"undo","#tool_redo":"redo","#tool_select":"select","#layer_rename":"text","#tool_image":"image","#tool_zoom":"zoom","#tool_clone":"clone","#tool_node_clone":"node_clone","#layer_delete,#tool_delete":"delete","#tool_node_delete":"node_delete","#tool_add_subpath":"add_subpath","#tool_openclose_path":"open_path","#tool_move_top":"move_top","#tool_move_bottom":"move_bottom","#tool_topath":"to_path","#tool_node_link":"link_controls","#tool_reorient":"reorient","#tool_group":"group","#tool_ungroup":"ungroup","#tool_unlink_use":"unlink_use","#tool_alignleft, #tool_posleft":"align_left","#tool_aligncenter, #tool_poscenter":"align_center","#tool_alignright, #tool_posright":"align_right","#tool_aligntop, #tool_postop":"align_top","#tool_alignmiddle, #tool_posmiddle":"align_middle","#tool_alignbottom, #tool_posbottom":"align_bottom","#cur_position":"align","#cur_linecap":"linecap_butt","#linecap_butt":"linecap_butt","#linecap_round":"linecap_round","#linecap_square":"linecap_square","#linejoin_miter,#cur_linejoin":"linejoin_miter","#linejoin_round":"linejoin_round","#linejoin_bevel":"linejoin_bevel","#url_notice":"warning","#layer_up":"go_up","#layer_down":"go_down","#layer_moreopts":"context_menu","#layerlist td.layervis":"eye","#tool_source_save,#tool_docprops_save,#tool_prefs_save":"ok","#tool_source_cancel,#tool_docprops_cancel,#tool_prefs_cancel":"cancel","#rwidthLabel, #iwidthLabel":"width","#rheightLabel, #iheightLabel":"height","#cornerRadiusLabel span":"c_radius","#angleLabel":"angle","#linkLabel,#tool_make_link,#tool_make_link_multi":"globe_link","#zoomLabel":"zoom","#tool_fill label":"fill","#tool_stroke label":"stroke","#group_opacityLabel":"opacity","#font_sizeLabel":"fontsize",".flyout_arrow_horiz":"arrow_right",".dropdown button, #main_button .dropdown":"arrow_down","#palette .palette_item:first, #fill_bg, #stroke_bg":"no_color"},resize:{"#logo .svg_icon":32,".flyout_arrow_horiz .svg_icon":5,".layer_button .svg_icon, #layerlist td.layervis .svg_icon":14,".dropdown button .svg_icon":7,"#main_button .dropdown .svg_icon":9,".palette_item:first .svg_icon, #fill_bg .svg_icon, #stroke_bg .svg_icon":16,".toolbar_button button .svg_icon":16,".stroke_tool div div .svg_icon":20,"#tools_bottom label .svg_icon":18},callback:function(icons){$(".toolbar_button button > svg, .toolbar_button button > img").each(function(){$(this).parent().prepend(this)});var tleft=$("#tools_left");if(tleft.length!=0){var min_height=tleft.offset().top+tleft.outerHeight()}$(".tools_flyout").each(function(){var shower=$("#"+this.id+"_show");var sel=shower.attr("data-curopt");if(!shower.children("svg, img").length){var clone=$(sel).children().clone();if(clone.length){clone[0].removeAttribute("style");shower.append(clone)}}});Editor.runCallbacks();setTimeout(function(){$(".flyout_arrow_horiz:empty").each(function(){$(this).append($.getSvgIcon("arrow_right").width(5).height(5))})},1)},no_img:true});Editor.canvas=svgCanvas=new $.SvgCanvas(document.getElementById("svgcanvas"),curConfig);var palette=["#ffffff","#bfbfbf","#7f7f7f","#3f3f3f","#000000","#efa8a8","#eb7979","#eb4646","#ef0f0f","#c50606","#990000","#efefa8","#ebeb79","#ebeb46","#efef0f","#c5c506","#989900","#a8efa8","#79eb79","#46eb46","#0fef0f","#06c506","#009900","#a8efef","#79ebeb","#46ebeb","#0fefef","#06c5c5","#009899","#a8a8ef","#7979eb","#4646eb","#0f0fef","#0606c5","#000099","#efa8ef","#eb79eb","#eb46eb","#ef0fef","#c506c5","#990098"],isMac=(navigator.platform.indexOf("Mac")>=0),isWebkit=(navigator.userAgent.indexOf("AppleWebKit")>=0),modKey=(isMac?"meta+":"ctrl+"),path=svgCanvas.pathActions,undoMgr=svgCanvas.undoMgr,Utils=svgedit.utilities,default_img_url=curConfig.imgPath+"logo.png",workarea=$("#workarea"),canv_menu=$("#cmenu_canvas"),layer_menu=$("#cmenu_layers"),show_save_warning=false,exportWindow=null,tool_scale=1,zoomInIcon="crosshair",zoomOutIcon="crosshair",ui_context="toolbars",orig_source="",paintBox={fill:null,stroke:null};var setSelectMode=function(){var curr=$(".tool_button_current");if(curr.length&&curr[0].id!=="tool_select"){curr.removeClass("tool_button_current").addClass("tool_button");$("#tool_select").addClass("tool_button_current").removeClass("tool_button");$("#styleoverrides").text("#svgcanvas svg *{cursor:move;pointer-events:all} #svgcanvas svg{cursor:default}")}svgCanvas.setMode("select");$("#tool_fill").addClass("disabled");$("#tool_stroke").addClass("disabled");workarea.css("cursor","auto")};var togglePathEditMode=function(editmode,elems){$("#path_node_panel").toggle(editmode);$("#tools_bottom_2,#tools_bottom_3").toggle(!editmode);if(editmode){$(".tool_button_current").removeClass("tool_button_current").addClass("tool_button");$("#tool_select").addClass("tool_button_current").removeClass("tool_button");setIcon("#tool_select","select_node");multiselected=false;if(elems.length){selectedElement=elems[0]}}else{setIcon("#tool_select","select")}};var flyoutspeed=1250;var textBeingEntered=false;var selectedElement=null;var multiselected=false;var editingsource=false;var docprops=false;var cur_context="";var orig_title=$("title:first").text();function cloud_save_as(callback){var currentFile='<?xml version="1.0"?>\n'+svgCanvas.getSvgString();$.post(domain+"/file_system/",{"svg_name":svgCanvas.getDocumentTitle(),"svg_data":currentFile},function(data){if(data){$.jGrowl(svgCanvas.getDocumentTitle()+".svg uploaded, now autosaving");console.log(data);file_ID=data;lastSVGSave=currentFile;fileDictionary[domain+"/file_system/file/"+file_ID]="data:image/svg+xml;base64,"+Utils.encode64(lastSVGSave);if(saveTimer){clearTimeout(saveTimer)}timedSaver(null);$("#main_icon").removeClass("blue");$("#main_icon").addClass("white");$("#tool_save_cloud").addClass("disabled");if(typeof(callback)!="undefined"){callback()}}}).error(function(xhr,stat,err){if(xhr.status==401){$.jGrowl("Please login from the popup window");popUp(domain+"/file_system/login/");$("#tool_save_cloud").removeClass("disabled");loggedIn=false}else{$.alert(": \n"+err+"")}})}var saveHandler=function(window,svg){show_save_warning=false;svg='<?xml version="1.0"?>\n'+svg;if(file_ID==null){cloud_save_as()}else{if(saveTimer){clearTimeout(saveTimer)}timedSaver(null)}};function download(){svg='<?xml version="1.0"?>\n'+svgCanvas.getSvgString();var bb=new BlobBuilder;bb.append(svg);$.getScript("HTML5/FileSaver.js",function(){saveAs(bb.getBlob("image/svg+xml"),svgCanvas.getDocumentTitle()+".svg")})}var exportHandler=function(window,data){$.getScript("HTML5/FileSaver.js",function(){$.getScript("HTML5/canvas-toBlob.js",function(){var issues=data.issues;if(!$("#export_canvas").length){$("<canvas>",{id:"export_canvas"}).hide().appendTo("body")}var c=$("#export_canvas")[0];c.width=svgCanvas.contentW;c.height=svgCanvas.contentH;canvg(c,data.svg,{renderCallback:function(){try{var datauri=c.toDataURL("image/png")}catch(err){$.jGrowl("Cannot convert to PNG because of external image URL(s)")}console.log(c);c.toBlob(function(blob){saveAs(blob,svgCanvas.getDocumentTitle()+".png")});return 0}})})})};var selectedChanged=function(window,elems){var mode=svgCanvas.getMode();if(mode==="select"){setSelectMode()}var is_node=(mode=="pathedit");selectedElement=(elems.length==1||elems[1]==null?elems[0]:null);multiselected=(elems.length>=2&&elems[1]!=null);if(selectedElement!=null){if(!is_node){updateToolbar()}}togglePathEditMode(is_node,elems);updateContextPanel();svgCanvas.runExtensions("selectedChanged",{elems:elems,selectedElement:selectedElement,multiselected:multiselected});if(_.isEmpty(_.difference(elems,[null]))&&svgCanvas.getMode()=="select"){$("#tool_fill").addClass("disabled");$("#tool_stroke").addClass("disabled")}};var elementTransition=function(window,elems){var mode=svgCanvas.getMode();var elem=elems[0];if(!elem){return}multiselected=(elems.length>=2&&elems[1]!=null);if(!multiselected){switch(mode){case"rotate":var ang=svgCanvas.getRotationAngle(elem);$("#angle").val(ang);$("#tool_reorient").toggleClass("disabled",ang==0);break}}svgCanvas.runExtensions("elementTransition",{elems:elems})};var elementChanged=function(window,elems){var mode=svgCanvas.getMode();if(mode==="select"){setSelectMode()}for(var i=0;i<elems.length;++i){var elem=elems[i];if(elem&&elem.tagName==="svg"){populateLayers();updateCanvas()}else{if(elem&&selectedElement&&selectedElement.parentNode==null){selectedElement=elem}}}updateContextPanel();if(svgCanvas.addedNew){var elname=elem.nodeName;if(elname==="image"){if(svgCanvas.getHref(elem).indexOf("data:")!==0){promptImgURL()}}}if(selectedElement&&mode==="select"){paintBox.fill.update();paintBox.stroke.update()}svgCanvas.runExtensions("elementChanged",{elems:elems});updateToolButtonState()};var zoomChanged=function(window,bbox,autoCenter){var scrbar=15,res=svgCanvas.getResolution(),w_area=workarea,canvas_pos=$("#svgcanvas").position();var z_info=svgCanvas.setBBoxZoom(bbox,w_area.width()-scrbar,w_area.height()-scrbar);if(!z_info){return}var zoomlevel=z_info.zoom,bb=z_info.bbox;if(zoomlevel<0.001){changeZoom({value:0.1});return}document.getElementById("zoom2").value=Math.round(zoomlevel*100);document.getElementById("zoomSlider2").value=Math.sqrt(Math.round(zoomlevel*100));$("#zoom").val(zoomlevel*100);if(autoCenter){updateCanvas()}else{updateCanvas(false,{x:bb.x*zoomlevel+(bb.width*zoomlevel)/2,y:bb.y*zoomlevel+(bb.height*zoomlevel)/2})}if(svgCanvas.getMode()=="zoom"&&bb.width){setSelectMode()}};$("#cur_context_panel").delegate("a","mouseup",function(){var link=$(this);if(link.attr("data-root")){svgCanvas.leaveContext()}else{svgCanvas.setContext(link.text())}return false});var contextChanged=function(win,context){$("#rulers").toggleClass("moved",context);if(cur_context&&!context){workarea[0].scrollTop-=25}else{if(!cur_context&&context){workarea[0].scrollTop+=25}}var link_str="";if(context){var str="";link_str='<a href="#" data-root="y">'+svgCanvas.getCurrentDrawing().getCurrentLayerName()+"</a>";$(context).parentsUntil("#svgcontent > g").andSelf().each(function(){if(this.id){str+=" > "+this.id;if(this!==context){link_str+=' > <a href="#">'+this.id+"</a>"}else{link_str+=" > "+this.id}}});cur_context=str}else{cur_context=null}$("#cur_context_panel").toggle(!!context).html(link_str);updateTitle()};var prepPaints=function(){paintBox.fill.prep();paintBox.stroke.prep()};var flyout_funcs={};var setupFlyouts=function(holders){$.each(holders,function(hold_sel,btn_opts){var buttons=$(hold_sel).children();var show_sel=hold_sel+"_show";var shower=$(show_sel);var def=false;buttons.addClass("tool_button").unbind("click mousedown mouseup").each(function(i){var opts=btn_opts[i];flyout_funcs[opts.sel]=opts.fn;if(opts.isDefault){def=i}var func=function(){if($(this).hasClass("disabled")){return false}if(toolButtonClick(show_sel)){opts.fn()}if(opts.icon){var icon=$.getSvgIcon(opts.icon,true)}else{var icon=$(opts.sel).children().eq(0).clone()}icon[0].setAttribute("width",shower.width());icon[0].setAttribute("height",shower.height());shower.children(":not(.flyout_arrow_horiz)").remove();shower.append(icon).attr("data-curopt",opts.sel)};$(this).mouseup(func);if(opts.key){$(document).bind("keydown",opts.key+"",func)}});if(def){shower.attr("data-curopt",btn_opts[def].sel)}else{if(!shower.attr("data-curopt")){shower.attr("data-curopt",btn_opts[0].sel)}}var timer;shower.mousedown(function(evt){if(shower.hasClass("disabled")){return false}var holder=$(show_sel.replace("_show",""));var l=holder[0].style.left;var w=holder.width()*-1;var time=holder.data("shown_popop")?0:0;timer=setTimeout(function(){if(!shower.data("isLibrary")){holder.css("left",w).show().animate({left:l},30)}else{holder.css("left",l).show()}holder.data("shown_popop",true)},time);evt.preventDefault()}).mouseup(function(evt){clearTimeout(timer);var opt=$(this).attr("data-curopt");if(shower.data("isLibrary")&&$(show_sel.replace("_show","")).is(":visible")){toolButtonClick(show_sel,true);return}if(toolButtonClick(show_sel)&&(opt in flyout_funcs)){flyout_funcs[opt]()}});var pos=$(show_sel).position();$(hold_sel).css({"left":pos.left+34,"top":pos.top+77})});setFlyoutTitles()};var makeFlyoutHolder=function(id,child){var div=$("<div>",{"class":"tools_flyout",id:id}).appendTo("#svg_editor").append(child);return div};var setFlyoutPositions=function(){$(".tools_flyout").each(function(){var shower=$("#"+this.id+"_show");var pos=shower.offset();var w=shower.outerWidth();$(this).css({left:(pos.left+w)*tool_scale,top:pos.top})})};var setFlyoutTitles=function(){$(".tools_flyout").each(function(){var shower=$("#"+this.id+"_show");if(shower.data("isLibrary")){return}var tooltips=[];$(this).children().each(function(){tooltips.push(this.title)});shower[0].title=tooltips.join(" / ")})};var extAdded=function(window,ext){var cb_called=false;var cb_ready=true;function prepResize(){}var runCallback=function(){if(ext.callback&&!cb_called&&cb_ready){cb_called=true;ext.callback()}};var btn_selects=[];if(ext.context_tools){$.each(ext.context_tools,function(i,tool){var cont_id=tool.container_id?(' id="'+tool.container_id+'"'):"";var panel=$("#"+tool.panel);if(!panel.length){panel=$("<div>",{id:tool.panel}).appendTo("#tools_top")}switch(tool.type){case"tool_button":var html='<div class="tool_button">'+tool.id+"</div>";var div=$(html).appendTo(panel);if(tool.events){$.each(tool.events,function(evt,func){$(div).bind(evt,func)})}break;case"select":var html="<label"+cont_id+">"+'<select id="'+tool.id+'">';$.each(tool.options,function(val,text){var sel=(val==tool.defval)?" selected":"";html+='<option value="'+val+'"'+sel+">"+text+"</option>"});html+="</select></label>";var sel=$(html).appendTo(panel).find("select");$.each(tool.events,function(evt,func){$(sel).bind(evt,func)});break;case"button-select":var html='<div id="'+tool.id+'" class="dropdown toolset" title="'+tool.title+'">'+'<div id="cur_'+tool.id+'" class="icon_label"></div><button></button></div>';var list=$('<ul id="'+tool.id+'_opts"></ul>').appendTo("#option_lists");if(tool.colnum){list.addClass("optcols"+tool.colnum)}var dropdown=$(html).appendTo(panel).children();btn_selects.push({elem:("#"+tool.id),list:("#"+tool.id+"_opts"),title:tool.title,callback:tool.events.change,cur:("#cur_"+tool.id)});break;case"input":var html="<label"+cont_id+">"+'<span id="'+tool.id+'_label">'+tool.label+":</span>"+'<input id="'+tool.id+'" title="'+tool.title+'" size="'+(tool.size||"4")+'" value="'+(tool.defval||"")+'" type="text"/></label>';var inp=$(html).appendTo(panel).find("input");if(tool.spindata){inp.SpinButton(tool.spindata)}if(tool.events){$.each(tool.events,function(evt,func){inp.bind(evt,func)})}break;default:break}})}if(ext.buttons){var fallback_obj={},placement_obj={},svgicons=ext.svgicons;var holders={};$.each(ext.buttons,function(i,btn){var icon;var id=btn.id;var num=i;while($("#"+id).length){id=btn.id+"_"+(++num)}if(!svgicons){icon=$('<img src="'+btn.icon+'">')}else{fallback_obj[id]=btn.icon;var svgicon=btn.svgicon?btn.svgicon:btn.id;if(btn.type=="app_menu"){placement_obj["#"+id+" > div"]=svgicon}else{placement_obj["#"+id]=svgicon}}var cls,parent;switch(btn.type){case"mode_flyout":case"mode":cls="tool_button";parent="#tools_left";break;case"context":cls="tool_button";parent="#"+btn.panel;if(!$(parent).length){$("<div>",{id:btn.panel}).appendTo("#tools_top")}break;case"app_menu":cls="";parent="#main_menu ul";break}var button=$((btn.list||btn.type=="app_menu")?"<li/>":"<div/>").attr("id",id).attr("title",btn.title).addClass(cls);if(!btn.includeWith&&!btn.list){if("position" in btn){$(parent).children().eq(btn.position).before(button)}else{button.appendTo(parent)}if(btn.type=="mode_flyout"){var ref_btn=$(button);var flyout_holder=ref_btn.parent();if(!ref_btn.parent().hasClass("tools_flyout")){var tls_id=ref_btn[0].id.replace("tool_","tools_");var show_btn=ref_btn.clone().attr("id",tls_id+"_show").append($("<div>",{"class":"flyout_arrow_horiz"}));ref_btn.before(show_btn);flyout_holder=makeFlyoutHolder(tls_id,ref_btn);flyout_holder.data("isLibrary",true);show_btn.data("isLibrary",true)}placement_obj["#"+tls_id+"_show"]=btn.id;var cur_h=holders["#"+flyout_holder[0].id]=[{sel:"#"+id,fn:btn.events.click,icon:btn.id,isDefault:true},ref_data]}else{if(btn.type=="app_menu"){button.append("<div>").append(btn.title)}}}else{if(btn.list){button.addClass("push_button");$("#"+btn.list+"_opts").append(button);if(btn.isDefault){$("#cur_"+btn.list).append(button.children().clone());var svgicon=btn.svgicon?btn.svgicon:btn.id;placement_obj["#cur_"+btn.list]=svgicon}}else{if(btn.includeWith){var opts=btn.includeWith;var ref_btn=$(opts.button);var flyout_holder=ref_btn.parent();if(!ref_btn.parent().hasClass("tools_flyout")){var tls_id=ref_btn[0].id.replace("tool_","tools_");var show_btn=ref_btn.clone().attr("id",tls_id+"_show").append($("<div>",{"class":"flyout_arrow_horiz"}));ref_btn.before(show_btn);flyout_holder=makeFlyoutHolder(tls_id,ref_btn)}var ref_data=Actions.getButtonData(opts.button);if(opts.isDefault){placement_obj["#"+tls_id+"_show"]=btn.id}var cur_h=holders["#"+flyout_holder[0].id]=[{sel:"#"+id,fn:btn.events.click,icon:btn.id,key:btn.key,isDefault:btn.includeWith?btn.includeWith.isDefault:0},ref_data];var pos=("position" in opts)?opts.position:"last";var len=flyout_holder.children().length;if(!isNaN(pos)&&pos>=0&&pos<len){flyout_holder.children().eq(pos).before(button)}else{flyout_holder.append(button);cur_h.reverse()}}}}if(!svgicons){button.append(icon)}if(!btn.list){$.each(btn.events,function(name,func){if(name=="click"){if(btn.type=="mode"){if(btn.includeWith){button.bind(name,func)}else{button.bind(name,function(){if(toolButtonClick(button)){func()}})}if(btn.key){$(document).bind("keydown",btn.key,func);if(btn.title){button.attr("title",btn.title+" ["+btn.key+"]")}}}else{button.bind(name,func)}}else{button.bind(name,func)}})}setupFlyouts(holders)});$.each(btn_selects,function(){addAltDropDown(this.elem,this.list,this.callback,{seticon:true})});if(svgicons){cb_ready=false}$.svgIcons(svgicons,{w:24,h:24,id_match:false,no_img:(!isWebkit),fallback:fallback_obj,placement:placement_obj,callback:function(icons){cb_ready=true;runCallback()}})}runCallback()};var getPaint=function(color,opac,type){var opts=null;if(color.indexOf("url(#")===0){var refElem=svgCanvas.getRefElem(color);if(refElem){refElem=refElem.cloneNode(true)}else{refElem=$("#"+type+"_color defs *")[0]}opts={alpha:opac};opts[refElem.tagName]=refElem}else{if(color.indexOf("#")===0){opts={alpha:opac,solidColor:color.substr(1)}}else{opts={alpha:opac,solidColor:"none"}}}return new $.jGraduate.Paint(opts)};var updateToolbar=function(){if(selectedElement!=null){switch(selectedElement.tagName){case"use":case"image":case"foreignObject":break;case"g":case"a":var gWidth=null;var childs=selectedElement.getElementsByTagName("*");for(var i=0,len=childs.length;i<len;i++){var swidth=childs[i].getAttribute("stroke-width");if(i===0){gWidth=swidth}else{if(gWidth!==swidth){gWidth=null}}}$("#stroke_width").val(gWidth===null?"":gWidth);paintBox.fill.update(true);paintBox.stroke.update(true);break;default:paintBox.fill.update(true);paintBox.stroke.update(true);$("#stroke_width").val(selectedElement.getAttribute("stroke-width")||2);$("#stroke_style").val(selectedElement.getAttribute("stroke-dasharray")||"none");var attr=selectedElement.getAttribute("stroke-linejoin")||"miter";if($("#linejoin_"+attr).length!=0){setStrokeOpt($("#linejoin_"+attr)[0])}attr=selectedElement.getAttribute("stroke-linecap")||"butt";if($("#linecap_"+attr).length!=0){setStrokeOpt($("#linecap_"+attr)[0])}}updateToolButtonState()}if(selectedElement!=null){var opac_perc=((selectedElement.getAttribute("opacity")||1)*100);$("#group_opacity").val(opac_perc);$("#elem_id").val(selectedElement.id)}};var setImageURL=Editor.setImageURL=function(url){if(!url){url=default_img_url}svgCanvas.setImageURL(url);$("#image_url").val(url);if(url.indexOf("data:")===0){$("#image_url").hide();$("#change_image_url").show()}else{svgCanvas.embedImage(url,function(datauri){if(!datauri){$("#url_notice").show()}else{$("#url_notice").hide()}default_img_url=url});$("#image_url").show();$("#change_image_url").show()}};var setInputWidth=function(elem){var w=Math.min(Math.max(12+elem.value.length*6,50),300);$(elem).width(w)};var updateContextPanel=function(){var elem=selectedElement;if(elem!=null&&!elem.parentNode){elem=null}var currentLayerName=svgCanvas.getCurrentDrawing().getCurrentLayerName();var currentMode=svgCanvas.getMode();var unit=curConfig.baseUnit!=="px"?curConfig.baseUnit:null;var is_node=currentMode=="pathedit";var menu_items=$("#cmenu_canvas li");$("#selected_panel, #multiselected_panel, #g_panel, #rect_panel, #circle_panel,                    #ellipse_panel, #line_panel, #text_panel, #image_panel, #container_panel, #use_panel, #a_panel, #filter_tools").hide();$("#tool_delete").toggleClass("disabled",true);$("#tool_clone").toggleClass("disabled",true);$("#tool_fill").removeClass("disabled");$("#tool_stroke").removeClass("disabled");if(_.any(svgCanvas.getSelectedElems(),_.identity)){var panelNames=["g","rect","image","text"];panelNames.forEach(function(element){if(_.all(svgCanvas.getSelectedElems(),function(e){if(e){return e.tagName==element}else{return true}})){$("#"+element+"_panel").show()}})}if(elem!=null){var elname=elem.nodeName;var angle=svgCanvas.getRotationAngle(elem);$("#angle").val(angle);$(".filter").each(function(){this.value=svgCanvas.getFilterVale(elem,this.getAttribute("data-filterName"),this.getAttribute("data-filterProperty"))});if(!is_node&&currentMode!="pathedit"){$("#selected_panel").show();$("#filter_tools").show();$("#tool_delete").toggleClass("disabled",false);$("#tool_clone").toggleClass("disabled",false);var no_path=["image","text","path","g","use"].indexOf(elname)==-1;$("#tool_topath").toggle(no_path);$("#tool_reorient").toggle(elname=="path");$("#tool_reorient").toggleClass("disabled",angle==0)}else{var point=path.getNodePoint();$("#tool_add_subpath").removeClass("push_button_pressed").addClass("tool_button");$("#tool_node_delete").toggleClass("disabled",!path.canDeleteNodes);setIcon("#tool_openclose_path",path.closed_subpath?"open_path":"close_path");if(point){var seg_type=$("#seg_type");if(unit){point.x=svgedit.units.convertUnit(point.x);point.y=svgedit.units.convertUnit(point.y)}$("#path_node_x").val(point.x);$("#path_node_y").val(point.y);if(point.type){seg_type.val(point.type).removeAttr("disabled")}else{seg_type.val(4).attr("disabled","disabled")}}return}var el_name=elem.tagName;var link_href=null;if(el_name==="a"){link_href=svgCanvas.getHref(elem);$("#g_panel").show()}if(elem.parentNode.tagName==="a"){if(!$(elem).siblings().length){$("#a_panel").show();link_href=svgCanvas.getHref(elem.parentNode)}}$("#tool_make_link, #tool_make_link").toggle(!link_href);if(link_href){$("#link_url").val(link_href)}var panels={g:[],a:[],rect:["rx","width","height"],image:["width","height"],text:[],"use":[]};if(panels[el_name]){var cur_panel=panels[el_name];$.each(cur_panel,function(i,item){var attrVal=elem.getAttribute(item);if(curConfig.baseUnit!=="px"&&elem[item]){var bv=elem[item].baseVal.value;attrVal=svgedit.units.convertUnit(bv)}$("#"+el_name+"_"+item).val(attrVal||0)});if(el_name=="text"){$("#text_panel").css("display","inline");if(svgCanvas.getItalic()){$("#tool_italic").addClass("push_button_pressed").removeClass("tool_button")}else{$("#tool_italic").removeClass("push_button_pressed").addClass("tool_button")}if(svgCanvas.getBold()){$("#tool_bold").addClass("push_button_pressed").removeClass("tool_button")}else{$("#tool_bold").removeClass("push_button_pressed").addClass("tool_button")}$("#font_family").val(elem.getAttribute("font-family"));$("#font_size").val(elem.getAttribute("font-size"));$("#text").val(svgCanvas.textActions.getTextContent(elem));if(svgCanvas.addedNew){setTimeout(function(){$("#text").focus().select()},100)}}else{if(el_name=="image"){setImageURL(svgCanvas.getHref(elem))}}}menu_items[(el_name==="g"?"en":"dis")+"ableContextMenuItems"]("#ungroup");menu_items[((el_name==="g"||!multiselected)?"dis":"en")+"ableContextMenuItems"]("#group")}else{if(multiselected){$("#multiselected_panel").show();$("#filter_tools").show();$("#tool_delete").toggleClass("disabled",false);$("#tool_clone").toggleClass("disabled",false);menu_items.enableContextMenuItems("#group").disableContextMenuItems("#ungroup")}else{menu_items.disableContextMenuItems("#delete,#cut,#copy,#group,#ungroup,#move_front,#move_up,#move_down,#move_back")}}if(undoMgr.getUndoStackSize()>0){$("#tool_undo").removeClass("disabled")}else{$("#tool_undo").addClass("disabled")}if(undoMgr.getRedoStackSize()>0){$("#tool_redo").removeClass("disabled")}else{$("#tool_redo").addClass("disabled")}svgCanvas.addedNew=false;if((elem&&!is_node)||multiselected){$("#selLayerNames").removeAttr("disabled").val(currentLayerName);canv_menu.enableContextMenuItems("#delete,#cut,#copy,#move_front,#move_up,#move_down,#move_back")}else{$("#selLayerNames").attr("disabled","disabled")}load_object_properties();$("#tool_save_cloud").removeClass("disabled")};$("#text").focus(function(){textBeingEntered=true});$("#text").blur(function(){textBeingEntered=false});svgCanvas.bind("selected",selectedChanged);svgCanvas.bind("transition",elementTransition);svgCanvas.bind("changed",elementChanged);svgCanvas.bind("saved",saveHandler);svgCanvas.bind("exported",exportHandler);svgCanvas.bind("zoomed",zoomChanged);svgCanvas.bind("contextset",contextChanged);svgCanvas.bind("extension_added",extAdded);svgCanvas.textActions.setInputElem($("#text")[0]);var str='<div class="palette_item" data-rgb="none"></div>';$.each(palette,function(i,item){str+='<div class="palette_item" style="background-color: '+item+';" data-rgb="'+item+'" title="Click to change fill, shift-click to change stroke color ('+item+')"></div>'});$("#palette").append(str);var color_blocks=["#FFF","#888","#000"];var str="";$.each(color_blocks,function(){str+='<div class="color_block" style="background-color:'+this+';"></div>'});$("#bg_blocks").append(str);var blocks=$("#bg_blocks div");var cur_bg="cur_background";blocks.each(function(){var blk=$(this);blk.click(function(){blocks.removeClass(cur_bg);$(this).addClass(cur_bg)})});if($.pref("img_save")){curPrefs.img_save=$.pref("img_save");$("#image_save_opts input").val([curPrefs.img_save])}var changeRectRadius=function(ctl){svgCanvas.setRectRadius(ctl.value)};var changeFontSize=function(ctl){svgCanvas.setFontSize(ctl.value)};var changeStrokeWidth=function(ctl){var val=ctl.value;if(val==0&&selectedElement&&["line","polyline"].indexOf(selectedElement.nodeName)>=0){val=ctl.value=1}svgCanvas.setStrokeWidth(val)};var changeRotationAngle=function(ctl){svgCanvas.setRotationAngle(ctl.value);$("#tool_reorient").toggleClass("disabled",ctl.value==0)};window["changeZoom"]=function(ctl){var zoomlevel=ctl.value/100;if(zoomlevel<0.001){ctl.value=0.1;return}var zoom=svgCanvas.getZoom();var w_area=workarea;zoomChanged(window,{width:0,height:0,x:(w_area[0].scrollLeft+w_area.width()/2)/zoom,y:(w_area[0].scrollTop+w_area.height()/2)/zoom,zoom:zoomlevel},true)};Editor.changeZoom=function(val){changeZoom({"value":val})};Editor.clickGroup=function(){clickGroup()};var changeOpacity=function(val){svgCanvas.setOpacity(val/100)};var changeBlur=function(ctl,val,noUndo){if(val==null){val=ctl.value}svgCanvas.setBlur(val)};var operaRepaint=function(){if(!window.opera){return}$("<p/>").hide().appendTo("body").remove()};$("#stroke_style").change(function(){svgCanvas.setStrokeAttr("stroke-dasharray",$(this).val());operaRepaint()});$("#stroke_linejoin").change(function(){svgCanvas.setStrokeAttr("stroke-linejoin",$(this).val());operaRepaint()});$("select").change(function(){$(this).blur()});var promptMoveLayerOnce=false;$("#selLayerNames").change(function(){var destLayer=this.options[this.selectedIndex].value;var confirm_str=uiStrings.notification.QmoveElemsToLayer.replace("%s",destLayer);var moveToLayer=function(ok){if(!ok){return}promptMoveLayerOnce=true;svgCanvas.moveSelectedToLayer(destLayer);svgCanvas.clearSelection();populateLayers()};if(destLayer){if(promptMoveLayerOnce){moveToLayer(true)}else{$.confirm(confirm_str,moveToLayer)}}});$("#font_family").change(function(){svgCanvas.setFontFamily(this.value)});$("#seg_type").change(function(){svgCanvas.setSegType($(this).val())});$("#text").keyup(function(e){if(e.keyCode==27){svgCanvas.textActions.toSelectMode(selectedElement)}else{svgCanvas.setTextContent(this.value)}});$("#image_url").change(function(){setImageURL(this.value)});$("#link_url").change(function(){if(this.value.length){svgCanvas.setLinkURL(this.value)}else{svgCanvas.removeHyperlink()}});$("#g_title").change(function(){svgCanvas.setGroupTitle(this.value)});$(".attr_changer").mousewheel(attr_onchange);$(".attr_changer").mouseup(attr_onchange);$(".attr_changer").keyup(attr_onchange);function attr_onchange(event){var attr=this.getAttribute("data-attr");var val=this.value;var valid=svgedit.units.isValidUnit(attr,val);if(!valid){this.value=selectedElement.getAttribute(attr);return false}if(attr!=="id"){if(isNaN(val)){val=svgCanvas.convertToNum(attr,val)}else{if(curConfig.baseUnit!=="px"){var unitData=svgedit.units.getTypeMap();if(selectedElement[attr]||svgCanvas.getMode()==="pathedit"||attr==="x"||attr==="y"){val*=unitData[curConfig.baseUnit]}}}}if(attr==="id"){var elem=selectedElement;svgCanvas.clearSelection();elem.id=val;svgCanvas.addToSelection([elem],true)}else{svgCanvas.changeSelectedAttribute(attr,val)}}palette_mousedown=function(evt){var right_click=evt.button===2;var isStroke=evt.shiftKey||right_click;var picker=isStroke?"stroke":"fill";var color=$(this).attr("data-rgb");var paint=null;if(svgCanvas.getMode()==="fhpath"||svgCanvas.getMode()==="line"||svgCanvas.getMode()==="connector"){isStroke=true}if(color==="transparent"||color==="initial"){color="none";paint=new $.jGraduate.Paint()}else{paint=new $.jGraduate.Paint({alpha:100,solidColor:color.substr(1)})}paintBox[picker].setPaint(paint);if(isStroke){svgCanvas.setColor("stroke",color);if(color!="none"&&svgCanvas.getStrokeOpacity()!=1){svgCanvas.setPaintOpacity("stroke",1)}}else{svgCanvas.setColor("fill",color);if(color!="none"&&svgCanvas.getFillOpacity()!=1){svgCanvas.setPaintOpacity("fill",1)}}updateToolButtonState()};$(".palette_item").mousedown(palette_mousedown).bind("contextmenu",function(e){e.preventDefault()});$(".palette_item").dblclick(function(event){if(svgCanvas.getMode()==="fhpath"||svgCanvas.getMode()==="line"||svgCanvas.getMode()==="connector"){colorPicker($("#stroke_color"))}else{colorPicker($("#fill_color"))}updateToolButtonState()});$("#palette").mouseover(function(){var inp=$('<input type="hidden">');$(this).append(inp);inp.focus().remove()});$("#toggle_stroke_tools").toggle(function(){$(".stroke_tool").css("display","table-cell");$(this).text("<<");resetScrollPos()},function(){$(".stroke_tool").css("display","none");$(this).text(">>");resetScrollPos()});var toolButtonClick=function(button,noHiding){if($(button).hasClass("disabled")){return false}if($(button).parent().hasClass("tools_flyout")){return true}var fadeFlyouts=fadeFlyouts||"normal";if(!noHiding){$(".tools_flyout").hide(fadeFlyouts)}$("#styleoverrides").text("");workarea.css("cursor","auto");$(".tool_button_current").removeClass("tool_button_current").addClass("tool_button");$(button).addClass("tool_button_current").removeClass("tool_button");return true};(function(){var last_x=null,last_y=null,w_area=workarea[0],panning=false,keypan=false;$("#svgcanvas").bind("mousemove mouseup",function(evt){if(panning===false){return}w_area.scrollLeft-=(evt.clientX-last_x);w_area.scrollTop-=(evt.clientY-last_y);last_x=evt.clientX;last_y=evt.clientY;if(evt.type==="mouseup"){panning=false}return false}).mousedown(function(evt){if(evt.button===1||keypan===true){evt.preventDefault();evt.stopPropagation();panning=true;last_x=evt.clientX;last_y=evt.clientY;return false}});$(window).mouseup(function(){panning=false});$(document).bind("keydown","space",function(evt){svgCanvas.spaceKey=keypan=true;evt.preventDefault()}).bind("keyup","space",function(evt){evt.preventDefault();svgCanvas.spaceKey=keypan=false}).bind("keydown","shift",function(evt){if(svgCanvas.getMode()==="zoom"){workarea.css("cursor",zoomOutIcon)}}).bind("keyup","shift",function(evt){if(svgCanvas.getMode()==="zoom"){workarea.css("cursor",zoomInIcon)}})}());function setStrokeOpt(opt,changeElem){var id=opt.id;var bits=id.split("_");var pre=bits[0];var val=bits[1];if(changeElem){svgCanvas.setStrokeAttr("stroke-"+pre,val)}operaRepaint();setIcon("#cur_"+pre,id,20);$(opt).addClass("current").siblings().removeClass("current")}(function(){var button=$("#main_icon");var list=$("#main_menu");var on_button=false;var height=0;var js_hover=true;var set_click=false;var hideMenu=function(){list.hide()};$(window).mouseup(function(evt){if(!on_button){button.removeClass("buttondown");if(evt.target.tagName!="INPUT"){list.hide()}else{if(!set_click){set_click=true;$(evt.target).click(function(){list.css("margin-left","-9999px").show()})}}}on_button=false}).mousedown(function(evt){var islib=$(evt.target).closest("div.tools_flyout, .contextMenu").length;if(!islib){$(".tools_flyout:visible,.contextMenu").hide()}});button.bind("mousedown",function(){if(!button.hasClass("buttondown")){button.addClass("buttondown").removeClass("buttonup");list.css("margin-left",0).show();if(!height){height=list.height()}list.css("height",height);on_button=true;return false}else{button.removeClass("buttondown").addClass("buttonup");list.hide()}}).hover(function(){on_button=true}).mouseout(function(){on_button=false});var list_items=$("#main_menu li");list_items.mouseover(function(){js_hover=($(this).css("background-color")=="rgba(0, 0, 0, 0)");list_items.unbind("mouseover");if(js_hover){list_items.mouseover(function(){this.style.backgroundColor="#FFC"}).mouseout(function(){this.style.backgroundColor="transparent";return true})}})}());Editor.addDropDown=function(elem,callback,dropUp){if($(elem).length==0){return}var button=$(elem).find("button");var list=$(elem).find("ul").attr("id",$(elem)[0].id+"-list");if(!dropUp){$("#option_lists").append(list)}var on_button=false;if(dropUp){$(elem).addClass("dropup")}list.find("li").bind("mouseup",callback);$(window).mouseup(function(evt){if(!on_button){button.removeClass("down");list.hide()}on_button=false});button.bind("mousedown",function(){if(!button.hasClass("down")){button.addClass("down");if(!dropUp){var pos=$(elem).position();list.css({top:pos.top+24,left:pos.left-10})}list.show();on_button=true}else{button.removeClass("down");list.hide()}}).hover(function(){on_button=true}).mouseout(function(){on_button=false})};var addAltDropDown=function(elem,list,callback,opts){var button=$(elem);var list=$(list);var on_button=false;var dropUp=opts.dropUp;if(dropUp){$(elem).addClass("dropup")}list.find("li").bind("mouseup",function(){if(opts.seticon){setIcon("#cur_"+button[0].id,$(this).children());$(this).addClass("current").siblings().removeClass("current")}callback.apply(this,arguments)});$(window).mouseup(function(evt){if(!on_button){button.removeClass("down");list.hide();list.css({top:0,left:0})}on_button=false});var height=list.height();$(elem).bind("mousedown",function(){var off=$(elem).offset();if(dropUp){off.top-=list.height();off.left+=8}else{off.top+=$(elem).height()}$(list).offset(off);if(!button.hasClass("down")){button.addClass("down");list.show();on_button=true;return false}else{button.removeClass("down");list.hide();list.css({top:0,left:0})}}).hover(function(){on_button=true}).mouseout(function(){on_button=false});if(opts.multiclick){list.mousedown(function(){on_button=true})}};Editor.addDropDown("#font_family_dropdown",function(){var fam=$(this).text();$("#font_family").val($(this).text()).change()});addAltDropDown("#stroke_linecap","#linecap_opts",function(){setStrokeOpt(this,true)},{dropUp:true});addAltDropDown("#stroke_linejoin","#linejoin_opts",function(){setStrokeOpt(this,true)},{dropUp:true});addAltDropDown("#tool_position","#position_opts",function(){var letter=this.id.replace("tool_pos","").charAt(0);svgCanvas.alignSelectedElements(letter,"page")},{multiclick:true});(function(){var inp;var unfocus=function(){$(inp).blur()};$("#svg_editor").find("button, select, input:not(#text)").focus(function(){inp=this;ui_context="toolbars";workarea.mousedown(unfocus)}).blur(function(){ui_context="canvas";workarea.unbind("mousedown",unfocus);if(svgCanvas.getMode()=="textedit"){$("#text").focus()}})}());var clickSelect=function(){if(toolButtonClick("#tool_select")){svgCanvas.setMode("select");$("#styleoverrides").text("#svgcanvas svg *{cursor:move;pointer-events:all}, #svgcanvas svg{cursor:default}");$("#tool_fill").addClass("disabled");$("#tool_stroke").addClass("disabled")}};var clickFHPath=function(){if(toolButtonClick("#tool_fhpath")){svgCanvas.setMode("fhpath");$("#tool_fill").addClass("disabled")}};var clickLine=function(){if(toolButtonClick("#tool_line")){svgCanvas.setMode("line");$("#tool_fill").addClass("disabled")}};var clickSquare=function(){if(toolButtonClick("#tool_square")){svgCanvas.setMode("square")}};var clickRect=function(){if(toolButtonClick("#tool_rect")){svgCanvas.setMode("rect")}};var clickFHRect=function(){if(toolButtonClick("#tool_fhrect")){svgCanvas.setMode("fhrect")}};var clickCircle=function(){if(toolButtonClick("#tool_circle")){svgCanvas.setMode("circle")}};var clickEllipse=function(){if(toolButtonClick("#tool_ellipse")){svgCanvas.setMode("ellipse")}};var clickFHEllipse=function(){if(toolButtonClick("#tool_fhellipse")){svgCanvas.setMode("fhellipse")}};var clickImage=function(){if(toolButtonClick("#tool_image")){svgCanvas.setMode("image");$("#tool_fill").addClass("disabled");$("#tool_stroke").addClass("disabled")}};var clickZoom=function(){if(toolButtonClick("#tool_zoom")){svgCanvas.setMode("zoom");workarea.css("cursor",zoomInIcon);$("#tool_fill").addClass("disabled");$("#tool_stroke").addClass("disabled")}};var dblclickZoom=function(){if(toolButtonClick("#tool_zoom")){zoomImage();setSelectMode()}};var clickText=function(){if(toolButtonClick("#tool_text")){svgCanvas.setMode("text")}};var clickPath=function(){if(toolButtonClick("#tool_path")){svgCanvas.setMode("path")}};var deleteSelected=function(){if(selectedElement!=null||multiselected){if(document.activeElement===document.body){svgCanvas.deleteSelectedElements()}}};var cutSelected=function(){if(selectedElement!=null||multiselected){svgCanvas.cutSelectedElements()}};var copySelected=function(){if(selectedElement!=null||multiselected){svgCanvas.copySelectedElements()}};var pasteInCenter=function(){var zoom=svgCanvas.getZoom();var x=(workarea[0].scrollLeft+workarea.width()/2)/zoom-svgCanvas.contentW;var y=(workarea[0].scrollTop+workarea.height()/2)/zoom-svgCanvas.contentH;svgCanvas.pasteElements(curConfig.pasteType,x,y)};var moveToTopSelected=function(){var groupAndUngroup=multiselected;if(selectedElement!=null||groupAndUngroup!=null){if(groupAndUngroup){svgCanvas.groupSelectedElements()}svgCanvas.moveToTopSelectedElement();if(groupAndUngroup){svgCanvas.ungroupSelectedElement()}}};var moveToBottomSelected=function(){var groupAndUngroup=multiselected;if(selectedElement!=null||groupAndUngroup!=null){if(groupAndUngroup){svgCanvas.groupSelectedElements()}svgCanvas.moveToBottomSelectedElement();if(groupAndUngroup){svgCanvas.ungroupSelectedElement()}}};var moveUpDownSelected=function(dir){if(selectedElement!=null){svgCanvas.moveUpDownSelected(dir)}};var convertToPath=function(){if(selectedElement!=null){svgCanvas.convertToPath()}};var reorientPath=function(){if(selectedElement!=null){path.reorient()}};var makeHyperlink=function(){if(selectedElement!=null||multiselected){$.prompt(uiStrings.notification.enterNewLinkURL,"http://",function(url){if(url){svgCanvas.makeHyperlink(url)}})}};var moveSelected=function(dx,dy){if(selectedElement!=null||multiselected){if(curConfig.gridSnapping){var multi=svgCanvas.getZoom()*curConfig.snappingStep;dx*=multi;dy*=multi}svgCanvas.moveSelectedElements(dx,dy)}};var linkControlPoints=function(){var linked=!$("#tool_node_link").hasClass("push_button_pressed");if(linked){$("#tool_node_link").addClass("push_button_pressed").removeClass("tool_button")}else{$("#tool_node_link").removeClass("push_button_pressed").addClass("tool_button")}path.linkControlPoints(linked)};var clonePathNode=function(){if(path.getNodePoint()){path.clonePathNode()}};var deletePathNode=function(){if(path.getNodePoint()){path.deletePathNode()}};var addSubPath=function(){var button=$("#tool_add_subpath");var sp=!button.hasClass("push_button_pressed");if(sp){button.addClass("push_button_pressed").removeClass("tool_button")}else{button.removeClass("push_button_pressed").addClass("tool_button")}path.addSubPath(sp)};var opencloseSubPath=function(){path.opencloseSubPath()};var selectNext=function(){svgCanvas.cycleElement(1)};var selectPrev=function(){svgCanvas.cycleElement(0)};var rotateSelected=function(cw,step){if(selectedElement==null||multiselected){return}if(!cw){step*=-1}var new_angle=$("#angle").val()*1+step;svgCanvas.setRotationAngle(new_angle);updateContextPanel()};var publishImage=function(){if(file_ID==null){cloud_save_as(publishImage)}else{$.confirm("This image will be published under a Creative Commons license. "+"See http://creativecommons.org/publicdomain/zero/1.0/",function(ok){if(ok){$.get("/file_system/set_file_properties/"+file_ID+"?public=t",function(data){$.jGrowl("Image has been published");window.open("/gallery?image=/file_system/file/"+file_ID+"?svg=yes")}).error(function(xhr,stat,err){console.log(xhr,stat,err);$.jGrowl("Error communicating with server")})}})}};var clickBold=function(){if($("#tool_bold").hasClass("push_button_pressed")){svgCanvas.setBold(false);$("#tool_bold").removeClass("push_button_pressed").addClass("tool_button")}else{$("#tool_bold").addClass("push_button_pressed").removeClass("tool_button");svgCanvas.setBold(true)}return false};var clickItalic=function(){if($("#tool_italic").hasClass("push_button_pressed")){svgCanvas.setItalic(false);$("#tool_italic").removeClass("push_button_pressed").addClass("tool_button")}else{$("#tool_italic").addClass("push_button_pressed").removeClass("tool_button");svgCanvas.setItalic(true)}return false};var clickSave=function(){var saveOpts={"images":curPrefs.img_save,"round_digits":6};svgCanvas.save(saveOpts)};var clickExport=function(){if(window.canvg){svgCanvas.rasterExport()}else{$.getScript("svg-edit/editor/canvg/rgbcolor.js",function(){$.getScript("svg-edit/editor/canvg/canvg.js",function(){svgCanvas.rasterExport()})})}};var clickOpen=function(){svgCanvas.open()};var clickImport=function(){};var lastSVGSave=null;var saveTimer=null;function timedSaver(callback){if(!svgCanvas.isUserDrawing()&&file_ID){$.getScript("diff_js_lib/diff_match_patch_uncompressed.js",function(){var dmp=new diff_match_patch();currentSVGString='<?xml version="1.0"?>\n'+svgCanvas.getSvgString();var patch=dmp.patch_make(lastSVGSave,dmp.diff_main(lastSVGSave,currentSVGString));if(patch.length!=0){console.log("Saving:");ajaxData={"patch_text":dmp.patch_toText(patch),"file_name":svgCanvas.getDocumentTitle()};$.ajax({type:"PUT",url:domain+"/file_system/file/"+file_ID,data:ajaxData,success:function(data){patchFailed=false;loggedIn=true;lastSVGSave=currentSVGString;fileDictionary["/file_system/file/"+file_ID]="data:image/svg+xml;base64,"+Utils.encode64(lastSVGSave);localStorage["fileDictionary"]=JSON.stringify(fileDictionary);$("#tool_save_cloud").addClass("disabled");if(callback){callback()}},error:function(xhr,stat,err){console.log(xhr,stat,err);if(xhr.status==401){$.jGrowl("Please login from the popup window");window.open(domain+"/file_system/login/");$("#tool_save_cloud").removeClass("disabled");loggedIn=false}else{if(xhr.status==422){ajaxData={"patch_text":"","file_name":svgCanvas.getDocumentTitle(),"file_text":currentSVGString};$.ajax({type:"PUT",url:domain+"/file_system/file/"+file_ID,data:ajaxData,success:function(data){patchFailed=false;loggedIn=true;lastSVGSave=currentSVGString;fileDictionary["/file_system/file/"+file_ID]="data:image/svg+xml;base64,"+Utils.encode64(lastSVGSave);localStorage["fileDictionary"]=JSON.stringify(fileDictionary);$("#tool_save_cloud").addClass("disabled");if(callback){callback()}}})}else{$.jGrowl("Error communicating with server")}}}})}else{$("#tool_save_cloud").addClass("disabled");if(callback){callback()}}})}if(loggedIn){saveTimer=setTimeout("timedSaver(null)",30000)}}window["timedSaver"]=timedSaver;function open_from_url(){$.prompt(uiStrings.notification.enterNewImgURL,"",function(url){console.log("open "+url);if(url){Editor.loadSVGFromURL(url,function(){})}})}Editor.loadSVGFromURL=function(url,callback){if(saveTimer){clearTimeout(saveTimer)}file_ID=null;svgCanvas.clear();console.log("open "+url);$.get(url,function(fileDataString){loggedIn=true;console.log("Loading SVG string",fileDataString);lastSVGSave=null;loadSvgString(fileDataString,function(s){if(s){callback(fileDataString);Editor.updateCanvas();zoomChanged(window,"canvas")}})}).error(function(xhr,stat,err){console.log(xhr,stat,err);$.jGrowl("Error communicating with server")})};var loggedIn=false;var userData={};var file_ID=null;var domain="http://www.vector-paint.com";var domain="";xmlhttprequest=$.getJSON(domain+"/file_system/loggedIn.json",function(data){if(data){userData=data;console.log("loggedIn.json",data);if(!data["loggedIn"]){window.open(domain+"/file_system/login/")}loggedIn=data["loggedIn"]}}).error(function(xhr,stat,err){console.log(xhr,stat,err);$.jGrowl("Error communicating with server")});function openLogout(){popUp(userData["logoutURL"])}function openCloudURL(resourceId){function oo(){Editor.loadSVGFromURL(domain+"/file_system/file/"+resourceId,function(fileDataString){console.log("finished loading "+resourceId);file_ID=resourceId;lastSVGSave=fileDataString;fileDictionary["/file_system/file/"+resourceId]="data:image/svg+xml;base64,"+Utils.encode64(lastSVGSave);localStorage["fileDictionary"]=JSON.stringify(fileDictionary);if(saveTimer){clearTimeout(saveTimer)}$.jGrowl("File opened (now autosaving).");$("#tool_save_cloud").addClass("disabled");timedSaver(null);$("#main_icon").removeClass("blue");$("#main_icon").addClass("white")})}if(file_ID){timedSaver(oo())}else{oo()}}document.getElementById("hide_open_file_dialog").onmouseup=function(){$("#open_file_dialog").hide()};var fileDictionary={};if(localStorage["fileDictionary"]){fileDictionary=JSON.parse(localStorage["fileDictionary"])}var clickOpenCloud=function(){$("#open_file_dialog").show();var parentParentElement=document.getElementById("file_selection").parentNode;var parentElement=document.getElementById("file_selection");parentElement.innerHTML="";var heading=document.createElement("h1");heading.innerHTML="Loading...";parentElement.appendChild(heading);$.getJSON(domain+"/file_system/filelist.json",function(data){parentParentElement.removeChild(parentElement);parentElement.innerHTML="";function image_click(resourceId){openCloudURL(resourceId);$("#open_file_dialog").fadeOut()}for(var i in data){if(data[i][0]){var svgImageContainer=document.createElement("div");svgImageContainer.setAttribute("data-resourceId",data[i][0]);var svgImage=document.createElement("img");console.log(data[i][0],file_ID);svgImage.alt=data[i][1];if(data[i][0]==file_ID){svgImage.className="imageThumbnailCurrent"}else{svgImage.onmouseup=function(){image_click($(this).parent().attr("data-resourceId"))};svgImage.title="Click to open image";svgImage.className="imageThumbnail"}if("/file_system/file/"+data[i][0] in fileDictionary){svgImage.src=fileDictionary["/file_system/file/"+data[i][0]]}else{svgImage.src=domain+"/file_system/file/"+data[i][0]+"?svg=yes"}svgImageContainer.appendChild(svgImage);svgImageContainer.appendChild(document.createElement("br"));var image_details=document.createElement("details");image_details.innerHTML="<summary>Delete Image</summary>";var delete_button=document.createElement("button");delete_button.onmouseup=function(){var idToDelete=$(this).parent().parent().attr("data-resourceId");document.getElementById("file_selection").removeChild(this.parentNode.parentNode);$.ajax({type:"DELETE",url:domain+"/file_system/file/"+idToDelete,success:function(data){if(idToDelete==file_ID){location.reload(true)}}})};delete_button.innerHTML="Delete";image_details.appendChild(delete_button);svgImageContainer.appendChild(image_details);parentElement.appendChild(svgImageContainer)}}parentParentElement.appendChild(parentElement)}).error(function(xhr,stat,err){console.log(xhr,stat,err);if(xhr.status==401){$("#open_file_dialog").hide();$.jGrowl("Please login from the popup window");window.open(domain+"/file_system/login/");loggedIn=false}else{if(xhr.status!=200){$("#open_file_dialog").hide();$.jGrowl("Error communicating with server")}}})};var clickUndo=function(event){if(undoMgr.getUndoStackSize()>0){undoMgr.undo();populateLayers()}switch(event.which){case 1:break;case 3:break}};var clickRedo=function(){if(undoMgr.getRedoStackSize()>0){undoMgr.redo();populateLayers()}};var clickGroup=function(){if(multiselected){svgCanvas.groupSelectedElements()}else{if(selectedElement){svgCanvas.ungroupSelectedElement()}}};var clickClone=function(){svgCanvas.cloneSelectedElements(20,20)};var clickAlign=function(){var letter=this.id.replace("tool_align","").charAt(0);svgCanvas.alignSelectedElements(letter,$("#align_relative_to").val())};var zoomImage=function(multiplier){var res=svgCanvas.getResolution();multiplier=multiplier?res.zoom*multiplier:1;document.getElementById("zoom2").value=Math.round(multiplier*100);document.getElementById("zoomSlider2").value=Math.sqrt(Math.round(multiplier*100));$("#zoom").val(multiplier*100);svgCanvas.setZoom(multiplier);updateCanvas(true)};var clickWireframe=function(){_gaq.push(["_trackEvent","wireframe","clicked"]);workarea.toggleClass("wireframe")};var clickGridframe=function(){var gr=!$("#view_grid").hasClass("push_button_pressed");if(gr){Editor.curConfig.showGrid=showGrid=true;$("#view_grid").addClass("push_button_pressed").removeClass("tool_button");$("#canvasGrid").attr("display","normal");updateGrid(svgCanvas.getZoom())}else{Editor.curConfig.showGrid=showGrid=false;$("#view_grid").removeClass("push_button_pressed").addClass("tool_button");$("#canvasGrid").attr("display","none")}};var showSourceEditor=function(e,forSaving){if(editingsource){return}editingsource=true;$("#save_output_btns").toggle(!!forSaving);$("#tool_source_back").toggle(!forSaving);var str=orig_source=svgCanvas.getSvgString();$("#svg_source_textarea").val(str);$("#svg_source_editor").fadeIn();$("#svg_source_textarea").focus()};var showDocProperties=function(){if(docprops){return}docprops=true;$("#image_save_opts input").val([curPrefs.img_save]);var res=svgCanvas.getResolution();if(curConfig.baseUnit!=="px"){res.w=svgedit.units.convertUnit(res.w)+curConfig.baseUnit;res.h=svgedit.units.convertUnit(res.h)+curConfig.baseUnit}$("#canvas_width").val(res.w);$("#canvas_height").val(res.h);$("#canvas_title").val(svgCanvas.getDocumentTitle());$("#svg_docprops").show()};var showPreferences=function(){$("#main_menu").hide();$("grid_snapping_step").attr("value",curConfig.snappingStep);if(curConfig.gridSnapping==true){$("#grid_snapping_on").attr("checked","checked")}else{$("#grid_snapping_on").removeAttr("checked")}if(curConfig.gridShow==true){$("#grid_display_on").attr("checked","checked")}else{$("#grid_display_on").removeAttr("checked")}$("#svg_prefs").show()};var saveSourceEditor=function(){if(!editingsource){return}var saveChanges=function(){svgCanvas.clearSelection();hideSourceEditor();zoomImage();populateLayers();updateTitle();prepPaints()};if(!svgCanvas.setSvgString($("#svg_source_textarea").val())){$.confirm(uiStrings.notification.QerrorsRevertToSource,function(ok){if(!ok){return false}saveChanges()})}else{saveChanges()}setSelectMode()};var updateTitle=function(title){title=title||svgCanvas.getDocumentTitle();var new_title=orig_title+(title?": "+title:"");$("title:first").text(new_title)};var saveDocProperties=function(){var new_title=$("#canvas_title").val();updateTitle(new_title);svgCanvas.setDocumentTitle(new_title);var width=$("#canvas_width"),w=width.val();var height=$("#canvas_height"),h=height.val();if(w!="fit"&&!svgedit.units.isValidUnit("width",w)){$.alert(uiStrings.notification.invalidAttrValGiven);width.parent().addClass("error");return false}width.parent().removeClass("error");if(h!="fit"&&!svgedit.units.isValidUnit("height",h)){$.alert(uiStrings.notification.invalidAttrValGiven);height.parent().addClass("error");return false}height.parent().removeClass("error");if(!svgCanvas.setResolution(w,h)){$.alert(uiStrings.notification.noContentToFitTo);return false}curPrefs.img_save=$("#image_save_opts :checked").val();$.pref("img_save",curPrefs.img_save);updateCanvas()};var savePreferences=function(){curConfig.gridSnapping=$("#grid_snapping_on")[0].checked;Editor.curConfig.showGrid=$("#grid_display_on")[0].checked;if(Editor.curConfig.showGrid){}curConfig.snappingStep=$("#grid_snapping_step").val();curConfig.showRulers=$("#show_rulers")[0].checked;if($("#show_rulers")[0].checked){_gaq.push(["_trackEvent","ruler","checked"])}if($("#grid_snapping_on")[0].checked){_gaq.push(["_trackEvent","snapping","checked"])}$("#rulers").toggle(curConfig.showRulers);if(curConfig.showRulers){updateRulers()}svgCanvas.setConfig(curConfig);updateCanvas()};var setIcon=Editor.setIcon=function(elem,icon_id,forcedSize){var icon=(typeof icon_id==="string")?$.getSvgIcon(icon_id,true):icon_id.clone();if(!icon){console.log("NOTE: Icon image missing: "+icon_id);return}$(elem).empty().append(icon)};var ua_prefix;(ua_prefix=function(){var regex=/^(Moz|Webkit|Khtml|O|ms|Icab)(?=[A-Z])/;var someScript=document.getElementsByTagName("script")[0];for(var prop in someScript.style){if(regex.test(prop)){return prop.match(regex)[0]}}if("WebkitOpacity" in someScript.style){return"Webkit"}if("KhtmlOpacity" in someScript.style){return"Khtml"}return""}());var scaleElements=function(elems,scale){var prefix="-"+ua_prefix.toLowerCase()+"-";var sides=["top","left","bottom","right"];elems.each(function(){var el=$(this);var w=el.outerWidth()*(scale-1);var h=el.outerHeight()*(scale-1);var margins={};for(var i=0;i<4;i++){var s=sides[i];var cur=el.data("orig_margin-"+s);if(cur==null){cur=parseInt(el.css("margin-"+s));el.data("orig_margin-"+s,cur)}var val=cur*scale;if(s==="right"){val+=w}else{if(s==="bottom"){val+=h}}el.css("margin-"+s,val)}})};var cancelOverlays=function(){$("#dialog_box").hide();$(".popup").hide();if(!editingsource&&!docprops){if(cur_context){svgCanvas.leaveContext()}return}if(docprops){hideDocProperties()}resetScrollPos()};var hideSourceEditor=function(){$("#svg_source_editor").hide();editingsource=false;$("#svg_source_textarea").blur()};var hideDocProperties=function(){$("#svg_docprops").hide();$("#canvas_width,#canvas_height").removeAttr("disabled");$("#resolution")[0].selectedIndex=0;$("#image_save_opts input").val([curPrefs.img_save]);docprops=false};var win_wh={width:$(window).width(),height:$(window).height()};var resetScrollPos=$.noop,curScrollPos;if(svgedit.browser.isIE()){(function(){resetScrollPos=function(){if(workarea[0].scrollLeft===0&&workarea[0].scrollTop===0){workarea[0].scrollLeft=curScrollPos.left;workarea[0].scrollTop=curScrollPos.top}};curScrollPos={left:workarea[0].scrollLeft,top:workarea[0].scrollTop};$(window).resize(resetScrollPos);Editor.ready(function(){setTimeout(function(){resetScrollPos()},500)});workarea.scroll(function(){curScrollPos={left:workarea[0].scrollLeft,top:workarea[0].scrollTop}})}())}$(window).resize(function(evt){$.each(win_wh,function(type,val){var curval=$(window)[type]();workarea[0]["scroll"+(type==="width"?"Left":"Top")]-=(curval-val)/2;win_wh[type]=curval})});(function(){workarea.scroll(function(){if($("#ruler_x").length!=0){$("#ruler_x")[0].scrollLeft=workarea[0].scrollLeft}if($("#ruler_y").length!=0){$("#ruler_y")[0].scrollTop=workarea[0].scrollTop}})}());$("#url_notice").click(function(){$.alert(this.title)});$("#change_image_url").click(promptImgURL);function pickerCallback(data){console.log(data);if(data.action==google.picker.Action.PICKED){setImageURL(data.docs[0].thumbnails[1].url)}}function promptImgURL(){var curhref="";if(selectedElement){curhref=svgCanvas.getHref(selectedElement)}curhref=curhref.indexOf("data:")===0?"":curhref;$.prompt(uiStrings.notification.enterNewImgURL,curhref,function(url){if(url){setImageURL(url)}})}if(isMac&&!window.opera){var shortcutButtons=["tool_clear","tool_save","tool_source","tool_undo","tool_redo","tool_clone"];var i=shortcutButtons.length;while(i--){var button=document.getElementById(shortcutButtons[i]);if(button!=null){var title=button.title;var index=title.indexOf("Ctrl+");button.title=[title.substr(0,index),"Cmd+",title.substr(index+5)].join("")}}}var colorPicker=function(elem){var picker=elem.attr("id")=="stroke_color"?"stroke":"fill";var paint=paintBox[picker].paint;if(paint.solidColor=="none"){paint.solidColor="4a90d6"}var title=(picker=="stroke"?"Pick a Stroke Paint and Opacity":"Pick a Fill Paint and Opacity");var was_none=false;var pos=elem.position();$("#color_picker").jGraduate({paint:paint,window:{pickerTitle:title},images:{clientPath:curConfig.jGraduatePath},newstop:"inverse"},function(p){paint=new $.jGraduate.Paint(p);paintBox[picker].setPaint(paint);svgCanvas.setPaint(picker,paint);$("#color_picker").hide()},function(p){$("#color_picker").hide()})};var parentElement=document.getElementById("feildDiv4");$("#propertiesLable").click(function(){_gaq.push(["_trackEvent","Properties","toggleVisability"]);if($("#feildDiv4").css("display")=="none"){$("#feildDiv4").css("display","block");load_object_properties()}else{$("#feildDiv4").css("display","none")}});$("#transformGrayscale").click(function(){transform_element_colors_to_grayscale(svgCanvas.getContentElem())});function transform_element_colors_to_grayscale(elements){$.each(elements,function(index,element){if(element!=null){if(element.childNodes!=null){transform_element_colors_to_grayscale(element.childNodes)}if(element.attributes!=null){$.each(element.attributes,function(i,v){if(v.nodeName=="stroke"||v.nodeName=="fill"||v.nodeName=="stop-color"){color=element.getAttribute(v.nodeName);if(color!="none"&&color[0]=="#"){RGB=hexToRGB(color);gray=RGB[0]*0.3+RGB[1]*0.59+RGB[2]*0.11;element.setAttribute(v.nodeName,rgbToHex([gray,gray,gray]))}}})}}})}function load_object_properties(){if($("#feildDiv4").css("display")=="none"){return}parentElement.innerHTML="";selected_objects=jQuery.grep(svgCanvas.getSelectedElems(),function(n,i){return(n!=null)});if(selected_objects.length==1){var attr_to_ignore=[];function oc(a){var o={};for(var i=0;i<a.length;i++){o[a[i]]=""}return o}selected_element=selected_objects[0];var label=document.createElement("label");label.innerHTML="&#60;"+selected_element.localName+"&#47;&gt;";parentElement.appendChild(label);var table=document.createElement("table");table.id="object_property_table";var tbody=document.createElement("tbody");table.appendChild(tbody);$.each(selected_element.attributes,function(i,v){if(selected_element.getAttribute(v.nodeName)!=null){var tr=document.createElement("tr");var td=document.createElement("td");tr.appendChild(td);var newLabel=document.createElement("label");newLabel.innerHTML=v.nodeName;td.appendChild(newLabel);var td=document.createElement("td");tr.appendChild(td);var newinput=document.createElement("input");newinput.setAttribute("data-attr",v.nodeName);newinput.setAttribute("value",selected_element.getAttribute(v.nodeName));newinput.setAttribute("class","attr_changer");newinput.onchange=attr_onchange;td.appendChild(newinput);tbody.appendChild(tr)}});parentElement.appendChild(table)}else{parentElement.innerHTML="No object selected"}}function object_properties_changed(){console.log(this)}function RGB2HSV(rgb){hsv=new Object();max=Math.max(rgb.r,rgb.g,rgb.b);dif=max-Math.min(rgb.r,rgb.g,rgb.b);hsv.saturation=(max==0)?0:(100*dif/max);if(hsv.saturation==0){hsv.hue=0}else{if(rgb.r==max){hsv.hue=60*(rgb.g-rgb.b)/dif}else{if(rgb.g==max){hsv.hue=120+60*(rgb.b-rgb.r)/dif}else{if(rgb.b==max){hsv.hue=240+60*(rgb.r-rgb.g)/dif}}}}if(hsv.hue<0){hsv.hue+=360}hsv.value=Math.round(max*100/255);hsv.hue=Math.round(hsv.hue);hsv.saturation=Math.round(hsv.saturation);return hsv}function HSV2RGB(hsv){var rgb=new Object();if(hsv.saturation==0){rgb.r=rgb.g=rgb.b=Math.round(hsv.value*2.55)}else{hsv.hue/=60;hsv.saturation/=100;hsv.value/=100;i=Math.floor(hsv.hue);f=hsv.hue-i;p=hsv.value*(1-hsv.saturation);q=hsv.value*(1-hsv.saturation*f);t=hsv.value*(1-hsv.saturation*(1-f));switch(i){case 0:rgb.r=hsv.value;rgb.g=t;rgb.b=p;break;case 1:rgb.r=q;rgb.g=hsv.value;rgb.b=p;break;case 2:rgb.r=p;rgb.g=hsv.value;rgb.b=t;break;case 3:rgb.r=p;rgb.g=q;rgb.b=hsv.value;break;case 4:rgb.r=t;rgb.g=p;rgb.b=hsv.value;break;default:rgb.r=hsv.value;rgb.g=p;rgb.b=q}rgb.r=Math.round(rgb.r*255);rgb.g=Math.round(rgb.g*255);rgb.b=Math.round(rgb.b*255)}return rgb}var updateToolButtonState=function(){toolFillStyle.innerHTML=".toolFillStyle svg *{fill: "+svgCanvas.getColor("fill")+";};";toolStrokeStyle.innerHTML=".toolStrokeStyle svg *{stroke: "+svgCanvas.getColor("stroke")+";}"+"#tools_shapelib_show svg *{fill: "+svgCanvas.getColor("fill")+";"+"stroke: "+svgCanvas.getColor("stroke")+";};";$(".canvas_palette_item").remove();var fill_palette=$.makeArray($(Editor.canvas.getContentElem()).find('[fill^="#"]').map(function(i,item){return $(item).attr("fill")}));var stroke_palette=$.makeArray($(Editor.canvas.getContentElem()).find('[stroke^="#"]').map(function(i,item){return $(item).attr("stroke")}));var canvas_palette=_.difference(_.union(stroke_palette,fill_palette),[null]);if(_.isEmpty(canvas_palette)){canvas_palette=["#222222","#4a90d6"]}var str="";$.each(canvas_palette,function(i,item){str+='<div class="palette_item canvas_palette_item" style="background-color: '+item+';" data-rgb="'+item+'" title="Click to change fill, shift-click to change stroke color ('+item+')"></div>'});$("#palette").append(str);$(".canvas_palette_item").mousedown(palette_mousedown).bind("contextmenu",function(e){e.preventDefault()});$(".canvas_palette_item").dblclick(function(event){if(svgCanvas.getMode()==="fhpath"||svgCanvas.getMode()==="line"||svgCanvas.getMode()==="connector"){colorPicker($("#stroke_color"))}else{colorPicker($("#fill_color"))}updateToolButtonState()});$("#canvas_palette_item").mouseover(function(){var inp=$('<input type="hidden">');$(this).append(inp);inp.focus().remove()})};var PaintBox=function(container,type){var cur=curConfig[type==="fill"?"initFill":"initStroke"];var svgdocbox=new DOMParser().parseFromString('<svg xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%"                    fill="#'+cur.color+'" opacity="'+cur.opacity+'"/>                    <defs><linearGradient id="gradbox_"/></defs></svg>',"text/xml");var docElem=svgdocbox.documentElement;docElem=$(container)[0].appendChild(document.importNode(docElem,true));docElem.setAttribute("width",16.5);this.rect=docElem.firstChild;this.defs=docElem.getElementsByTagName("defs")[0];this.grad=this.defs.firstChild;this.paint=new $.jGraduate.Paint({solidColor:cur.color});this.type=type;this.setPaint=function(paint,apply){this.paint=paint;var fillAttr="none";var ptype=paint.type;var opac=paint.alpha/100;switch(ptype){case"solidColor":fillAttr="#"+paint[ptype];break;case"linearGradient":case"radialGradient":this.defs.removeChild(this.grad);this.grad=this.defs.appendChild(paint[ptype]);var id=this.grad.id="gradbox_"+this.type;fillAttr="url(#"+id+")"}this.rect.setAttribute("fill",fillAttr);this.rect.setAttribute("opacity",opac);if(apply){svgCanvas.setColor(this.type,paintColor,true);svgCanvas.setPaintOpacity(this.type,paintOpacity,true)}};this.update=function(apply){if(!selectedElement){return}var type=this.type;switch(selectedElement.tagName){case"use":case"image":case"foreignObject":return;case"g":case"a":var gPaint=null;var childs=selectedElement.getElementsByTagName("*");for(var i=0,len=childs.length;i<len;i++){var elem=childs[i];var p=elem.getAttribute(type);if(i===0){gPaint=p}else{if(gPaint!==p){gPaint=null;break}}}if(gPaint===null){var paintColor=null;return}var paintColor=gPaint;var paintOpacity=1;break;default:var paintOpacity=parseFloat(selectedElement.getAttribute(type+"-opacity"));if(isNaN(paintOpacity)){paintOpacity=1}var defColor=type==="fill"?"black":"none";var paintColor=selectedElement.getAttribute(type)||defColor}if(apply){svgCanvas.setColor(type,paintColor,true);svgCanvas.setPaintOpacity(type,paintOpacity,true)}paintOpacity*=100;var paint=getPaint(paintColor,paintOpacity,type);this.setPaint(paint)};this.prep=function(){var ptype=this.paint.type;switch(ptype){case"linearGradient":case"radialGradient":var paint=new $.jGraduate.Paint({copy:this.paint});svgCanvas.setPaint(type,paint)}}};paintBox.fill=new PaintBox("#fill_color","fill");paintBox.stroke=new PaintBox("#stroke_color","stroke");$("#stroke_width").val(curConfig.initStroke.width);$("#group_opacity").val(curConfig.initOpacity*100);var test_el=paintBox.fill.rect.cloneNode(false);test_el.setAttribute("style","vector-effect:non-scaling-stroke");var supportsNonSS=(test_el.style.vectorEffect==="non-scaling-stroke");test_el.removeAttribute("style");var svgdocbox=paintBox.fill.rect.ownerDocument;var blur_test=svgdocbox.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");if(typeof blur_test.stdDeviationX==="undefined"){$("#tool_blur").hide()}$(blur_test).remove();(function(){var pre="-"+ua_prefix.toLowerCase()+"-zoom-";var zoom=pre+"in";workarea.css("cursor",zoom);if(workarea.css("cursor")===zoom){zoomInIcon=zoom;zoomOutIcon=pre+"out"}workarea.css("cursor","auto")}());setTimeout(function(){svgCanvas.embedImage("images/kitten.jpg",function(datauri){if(!datauri){$("#image_save_opts [value=embed]").attr("disabled","disabled");$("#image_save_opts input").val(["ref"]);curPrefs.img_save="ref";$("#image_opt_embed").css("color","#666").attr("title",uiStrings.notification.featNotSupported)}})},1000);$("#tool_fill").mouseup(function(){if(!$(this).hasClass("disabled")){colorPicker($("#fill_color"));updateToolButtonState()}});$("#tool_stroke").mouseup(function(){if(!$(this).hasClass("disabled")){colorPicker($("#stroke_color"));updateToolButtonState()}});$("#group_opacityLabel").mouseup(function(){$("#opacity_dropdown button").mousedown();$(window).mouseup()});$("#zoomLabel").mouseup(function(){$("#zoom_dropdown button").mousedown();$(window).mouseup()});$("#tool_move_top").mousedown(function(evt){$("#tools_stacking").show();evt.preventDefault()});$(".layer_button").mousedown(function(){$(this).addClass("layer_buttonpressed")}).mouseout(function(){$(this).removeClass("layer_buttonpressed")}).mouseup(function(){$(this).removeClass("layer_buttonpressed")});$(".push_button").mousedown(function(){if(!$(this).hasClass("disabled")){$(this).addClass("push_button_pressed").removeClass("push_button")}}).mouseout(function(){$(this).removeClass("push_button_pressed").addClass("push_button")}).mouseup(function(){$(this).removeClass("push_button_pressed").addClass("push_button")});$("#layer_new").mouseup(function(){var i=svgCanvas.getCurrentDrawing().getNumLayers();do{var uniqName=uiStrings.layers.layer+" "+ ++i}while(svgCanvas.getCurrentDrawing().hasLayer(uniqName));$.prompt(uiStrings.notification.enterUniqueLayerName,uniqName,function(newName){if(!newName){return}if(svgCanvas.getCurrentDrawing().hasLayer(newName)){$.alert(uiStrings.notification.dupeLayerName);return}svgCanvas.createLayer(newName);updateContextPanel();populateLayers()})});function deleteLayer(){if(svgCanvas.deleteCurrentLayer()){updateContextPanel();populateLayers();$("#layerlist tr.layer").removeClass("layersel");$("#layerlist tr.layer:first").addClass("layersel")}}function cloneLayer(){var name=svgCanvas.getCurrentDrawing().getCurrentLayerName()+" copy";$.prompt(uiStrings.notification.enterUniqueLayerName,name,function(newName){if(!newName){return}if(svgCanvas.getCurrentDrawing().hasLayer(newName)){$.alert(uiStrings.notification.dupeLayerName);return}svgCanvas.cloneLayer(newName);updateContextPanel();populateLayers()})}function mergeLayer(){if($("#layerlist tr.layersel").index()==svgCanvas.getCurrentDrawing().getNumLayers()-1){return}svgCanvas.mergeLayer();updateContextPanel();populateLayers()}function moveLayer(pos){var curIndex=$("#layerlist tr.layersel").index();var total=svgCanvas.getCurrentDrawing().getNumLayers();if(curIndex>0||curIndex<total-1){curIndex+=pos;svgCanvas.setCurrentLayerPosition(total-curIndex-1);populateLayers()}}$("#layer_delete").mouseup(deleteLayer);$("#layer_up").mouseup(function(){moveLayer(-1)});$("#layer_down").mouseup(function(){moveLayer(1)});$("#layer_rename").mouseup(function(){var curIndex=$("#layerlist tr.layersel").prevAll().length;var oldName=$("#layerlist tr.layersel td.layername").text();$.prompt(uiStrings.notification.enterNewLayerName,"",function(newName){if(!newName){return}if(oldName==newName||svgCanvas.getCurrentDrawing().hasLayer(newName)){$.alert(uiStrings.notification.layerHasThatName);return}svgCanvas.renameCurrentLayer(newName);populateLayers()})});var toggleHighlightLayer=function(layerNameToHighlight){var curNames=new Array(svgCanvas.getCurrentDrawing().getNumLayers());for(var i=0;i<curNames.length;++i){curNames[i]=svgCanvas.getCurrentDrawing().getLayerName(i)}if(layerNameToHighlight){for(var i=0;i<curNames.length;++i){if(curNames[i]!=layerNameToHighlight){svgCanvas.getCurrentDrawing().setLayerOpacity(curNames[i],0.5)}}}else{for(var i=0;i<curNames.length;++i){svgCanvas.getCurrentDrawing().setLayerOpacity(curNames[i],1)}}};var populateLayers=function(){var layerlist=$("#layerlist tbody");var selLayerNames=$("#selLayerNames");layerlist.empty();selLayerNames.empty();var currentLayerName=svgCanvas.getCurrentDrawing().getCurrentLayerName();var layer=svgCanvas.getCurrentDrawing().getNumLayers();var icon=$.getSvgIcon("eye");while(layer--){var name=svgCanvas.getCurrentDrawing().getLayerName(layer);var appendstr='<tr class="layer';if(name==currentLayerName){appendstr+=" layersel"}appendstr+='">';if(svgCanvas.getCurrentDrawing().getLayerVisibility(name)){appendstr+='<td class="layervis"/><td class="layername" >'+name+"</td></tr>"}else{appendstr+='<td class="layervis layerinvis"/><td class="layername" >'+name+"</td></tr>"}layerlist.append(appendstr);selLayerNames.append('<option value="'+name+'">'+name+"</option>")}if(icon!==undefined){var copy=icon.clone();$("td.layervis",layerlist).append(icon.clone());$.resizeSvgIcons({"td.layervis .svg_icon":14})}$("#layerlist td.layername").mouseup(function(evt){$("#layerlist tr.layer").removeClass("layersel");var row=$(this.parentNode);row.addClass("layersel");svgCanvas.setCurrentLayer(this.textContent);evt.preventDefault()}).mouseover(function(evt){$(this).css({"font-style":"italic","color":"blue"});toggleHighlightLayer(this.textContent)}).mouseout(function(evt){$(this).css({"font-style":"normal","color":"black"});toggleHighlightLayer()});$("#layerlist td.layervis").mouseup(function(evt){var row=$(this.parentNode).prevAll().length;var name=$("#layerlist tr.layer:eq("+row+") td.layername").text();var vis=$(this).hasClass("layerinvis");svgCanvas.setLayerVisibility(name,vis);if(vis){$(this).removeClass("layerinvis")}else{$(this).addClass("layerinvis")}});var num=5-$("#layerlist tr.layer").size();while(num-->0){layerlist.append('<tr><td style="color:white">_</td><td/></tr>')}};populateLayers();var centerCanvas=function(){workarea.css("line-height",workarea.height()+"px")};$(window).bind("load resize",centerCanvas);function stepFontSize(elem,step){var orig_val=elem.value-0;var sug_val=orig_val+step;var increasing=sug_val>=orig_val;if(step===0){return orig_val}if(orig_val>=24){if(increasing){return Math.round(orig_val*1.1)}else{return Math.round(orig_val/1.1)}}else{if(orig_val<=1){if(increasing){return orig_val*2}else{return orig_val/2}}else{return sug_val}}}function stepZoom(elem,step){var orig_val=elem.value-0;if(orig_val===0){return 100}var sug_val=orig_val+step;if(step===0){return orig_val}if(orig_val>=100){return sug_val}else{if(sug_val>=orig_val){return orig_val*2}else{return orig_val/2}}}$("#resolution").change(function(){var wh=$("#canvas_width,#canvas_height");if(!this.selectedIndex){if($("#canvas_width").val()=="fit"){wh.removeAttr("disabled").val(100)}}else{if(this.value=="content"){wh.val("fit").attr("disabled","disabled")}else{var dims=this.value.split("x");$("#canvas_width").val(dims[0]);$("#canvas_height").val(dims[1]);wh.removeAttr("disabled")}}});$("input,select").attr("autocomplete","off");var Actions=function(){var tool_buttons=[{sel:"#tool_select",fn:clickSelect,evt:"mouseup",key:["V",true]},{sel:"#tool_fhpath",fn:clickFHPath,evt:"mouseup",key:["Q",true]},{sel:"#tool_line",fn:clickLine,evt:"mouseup",key:["L",true]},{sel:"#tool_rect",fn:clickRect,evt:"mouseup",key:["R",true],parent:"#tools_rect",icon:"rect"},{sel:"#tool_ellipse",fn:clickEllipse,evt:"mouseup",key:["E",true],parent:"#tools_ellipse",icon:"ellipse"},{sel:"#tool_path",fn:clickPath,evt:"mouseup",key:["P",true]},{sel:"#tool_text",fn:clickText,evt:"mouseup",key:["T",true]},{sel:"#tool_image",fn:clickImage,evt:"mouseup",key:["I",true]},{sel:"#tool_zoom",fn:clickZoom,evt:"mouseup"},{sel:"#tool_save_cloud",fn:function(){editingsource?saveSourceEditor():clickSave()},evt:"mouseup",key:["S",true]},{sel:"#tool_save_as_cloud",fn:cloud_save_as,evt:"mouseup"},{sel:"#tool_publish",fn:publishImage,evt:"mouseup"},{sel:"#tool_gallery",fn:function(){window.open("/gallery")},evt:"mouseup"},{sel:"#tool_save",fn:download,evt:"mouseup"},{sel:"#tool_open_url",fn:open_from_url,evt:"mouseup"},{sel:"#tool_export",fn:clickExport,evt:"mouseup"},{sel:"#tool_logout",fn:openLogout,evt:"mouseup"},{sel:"#tool_open",fn:clickOpen,evt:"mouseup"},{sel:"#tool_open_cloud",fn:clickOpenCloud,evt:"mouseup",key:["O",true]},{sel:"#tool_new_file",fn:function(){timedSaver(null);location.reload(true)},evt:"mouseup"},{sel:"#tool_import",fn:clickImport,evt:"mouseup"},{sel:"#tool_source",fn:showSourceEditor,evt:"mouseup",key:["f3",true]},{sel:"#tool_source_cancel,#svg_source_overlay,#tool_docprops_cancel,#tool_prefs_cancel",fn:cancelOverlays,evt:"mouseup",key:["esc",false,false],hidekey:true},{sel:"#tool_source_save",fn:saveSourceEditor,evt:"mouseup"},{sel:"#tool_wireframe_check",fn:clickWireframe,evt:"click",key:["F",true]},{sel:"#tool_grid_check",fn:clickGridframe,evt:"mouseup"},{sel:"#tool_source_cancel,#svg_source_overlay,#tool_docprops_cancel,#tool_prefs_cancel",fn:cancelOverlays,evt:"mouseup",key:["esc",false,false],hidekey:true},{sel:"#tool_docprops_save",fn:function(){saveDocProperties();hideDocProperties()},evt:"mouseup"},{sel:"#tool_docprops",fn:showDocProperties,evt:"mouseup"},{sel:"#tool_prefs_save",fn:savePreferences,evt:"mouseup"},{sel:"#tool_prefs_option",fn:function(){showPreferences();_gaq.push(["_trackEvent","EditView","clicked"]);return false},evt:"mouseup"},{sel:"#tool_delete",fn:deleteSelected,evt:"mouseup",key:["del/backspace",true]},{sel:"#tool_reorient",fn:reorientPath,evt:"mouseup"},{sel:"#tool_node_link",fn:linkControlPoints,evt:"mouseup"},{sel:"#tool_node_clone",fn:clonePathNode,evt:"mouseup"},{sel:"#tool_node_delete",fn:deletePathNode,evt:"mouseup"},{sel:"#tool_openclose_path",fn:opencloseSubPath,evt:"mouseup"},{sel:"#tool_add_subpath",fn:addSubPath,evt:"mouseup"},{sel:"#tool_move_top",fn:moveToTopSelected,evt:"mouseup",key:"ctrl+shift+]"},{sel:"#tool_move_bottom",fn:moveToBottomSelected,evt:"mouseup",key:"ctrl+shift+["},{sel:"#tool_topath",fn:convertToPath,evt:"mouseup"},{sel:"#tool_make_link",fn:makeHyperlink,evt:"mouseup"},{sel:"#tool_undo",fn:clickUndo,evt:"mouseup",key:["Z",true]},{sel:"#tool_redo",fn:clickRedo,evt:"mouseup",key:["Y",true]},{sel:"#tool_clone",fn:clickClone,evt:"mouseup",key:["D",true]},{sel:"#tool_group",fn:clickGroup,evt:"mouseup",key:["G",true]},{sel:"#tool_ungroup",fn:clickGroup,evt:"mouseup"},{sel:"#tool_unlink_use",fn:clickGroup,evt:"mouseup"},{sel:"[id^=tool_align]",fn:clickAlign,evt:"mouseup"},{sel:"#tool_bold",fn:clickBold,evt:"mousedown"},{sel:"#tool_italic",fn:clickItalic,evt:"mousedown"},{sel:"#copy_save_done",fn:cancelOverlays,evt:"mouseup"},{key:"ctrl+left",fn:function(){rotateSelected(0,1)}},{key:"ctrl+right",fn:function(){rotateSelected(1,1)}},{key:"ctrl+shift+left",fn:function(){rotateSelected(0,5)}},{key:"ctrl+shift+right",fn:function(){rotateSelected(1,5)}},{key:"shift+O",fn:selectPrev},{key:"shift+P",fn:selectNext},{key:[modKey+"up",true],fn:function(){zoomImage(2)}},{key:[modKey+"down",true],fn:function(){zoomImage(0.5)}},{key:[modKey+"]",true],fn:function(){moveUpDownSelected("Up")}},{key:[modKey+"[",true],fn:function(){moveUpDownSelected("Down")}},{key:["up",true],fn:function(){moveSelected(0,-1)}},{key:["down",true],fn:function(){moveSelected(0,1)}},{key:["left",true],fn:function(){moveSelected(-1,0)}},{key:["right",true],fn:function(){moveSelected(1,0)}},{key:"shift+up",fn:function(){moveSelected(0,-10)}},{key:"shift+down",fn:function(){moveSelected(0,10)}},{key:"shift+left",fn:function(){moveSelected(-10,0)}},{key:"shift+right",fn:function(){moveSelected(10,0)}},{key:["alt+up",true],fn:function(){svgCanvas.cloneSelectedElements(0,-1)}},{key:["alt+down",true],fn:function(){svgCanvas.cloneSelectedElements(0,1)}},{key:["alt+left",true],fn:function(){svgCanvas.cloneSelectedElements(-1,0)}},{key:["alt+right",true],fn:function(){svgCanvas.cloneSelectedElements(1,0)}},{key:["alt+shift+up",true],fn:function(){svgCanvas.cloneSelectedElements(0,-10)}},{key:["alt+shift+down",true],fn:function(){svgCanvas.cloneSelectedElements(0,10)}},{key:["alt+shift+left",true],fn:function(){svgCanvas.cloneSelectedElements(-10,0)}},{key:["alt+shift+right",true],fn:function(){svgCanvas.cloneSelectedElements(10,0)}},{key:"A",fn:function(){svgCanvas.selectAllInCurrentLayer()}},{key:modKey+"z",fn:clickUndo},{key:modKey+"shift+z",fn:clickRedo},{key:modKey+"y",fn:clickRedo},{key:modKey+"x",fn:cutSelected},{key:modKey+"c",fn:copySelected},{key:modKey+"v",fn:function(){svgCanvas.pasteElements("point",20,20)}}];var key_assocs={"4/Shift+4":"#tools_rect_show","5/Shift+5":"#tools_ellipse_show"};return{setAll:function(){var flyouts={};$.each(tool_buttons,function(i,opts){if(opts.sel){var btn=$(opts.sel);if(btn.length==0){return true}if(opts.evt){btn[opts.evt](opts.fn)}if(opts.parent&&$(opts.parent+"_show").length!=0){var f_h=$(opts.parent);if(!f_h.length){f_h=makeFlyoutHolder(opts.parent.substr(1))}f_h.append(btn);if(!$.isArray(flyouts[opts.parent])){flyouts[opts.parent]=[]}flyouts[opts.parent].push(opts)}}if(opts.key){var keyval,shortcut="",disInInp=true,fn=opts.fn,pd=false;if($.isArray(opts.key)){keyval=opts.key[0];if(opts.key.length>1){pd=opts.key[1]}if(opts.key.length>2){disInInp=opts.key[2]}}else{keyval=opts.key}keyval+="";$.each(keyval.split("/"),function(i,key){$(document).bind("keydown",key,function(e){if(document.activeElement===document.body){fn();if(pd){e.preventDefault()}return false}else{return true}})})}});setupFlyouts(flyouts);$(window).bind("keydown","tab",function(e){if(ui_context==="canvas"){e.preventDefault();selectNext()}}).bind("keydown","shift+tab",function(e){if(ui_context==="canvas"){e.preventDefault();selectPrev()}});$("#tool_zoom").dblclick(dblclickZoom)},setTitles:function(){$.each(key_assocs,function(keyval,sel){var menu=($(sel).parents("#main_menu").length);$(sel).each(function(){if(menu){var t=$(this).text().split(" [")[0]}else{var t=this.title.split(" [")[0]}var key_str="";$.each(keyval.split("/"),function(i,key){var mod_bits=key.split("+"),mod="";if(mod_bits.length>1){mod=mod_bits[0]+"+";key=mod_bits[1]}key_str+=(i?"/":"")+mod+(uiStrings["key_"+key]||key)});if(menu){this.lastChild.textContent=t+" ["+key_str+"]"}else{this.title=t+" ["+key_str+"]"}})})},getButtonData:function(sel){var b;$.each(tool_buttons,function(i,btn){if(btn.sel===sel){b=btn}});return b}}}();Actions.setAll();Editor.ready(function(){var tool,itool=curConfig.initTool,container=$("#tools_left, #svg_editor .tools_flyout"),pre_tool=container.find("#tool_"+itool),reg_tool=container.find("#"+itool);if(pre_tool.length){tool=pre_tool}else{if(reg_tool.length){tool=reg_tool}else{tool=$("#tool_select")}}tool.click().mouseup();if(curConfig.wireframe){$("#tool_wireframe").click()}if(curConfig.showlayers){toggleSidePanel()}$("#rulers").toggle(!!curConfig.showRulers);$("#show_rulers")[0].checked=curConfig.showRulers;if(curConfig.gridSnapping){$("#grid_snapping_on")[0].checked=true}if(curConfig.baseUnit){$("#base_unit").val(curConfig.baseUnit)}if(curConfig.snappingStep){$("#grid_snapping_step").val(curConfig.snappingStep)}});function add_input_events(ele,func){ele.onmousewheel=func;ele.onmouseup=func;ele.onkeyup=func}document.getElementById("show_rulers").onclick=function(){savePreferences()};document.getElementById("grid_snapping_on").onclick=function(){savePreferences()};document.getElementById("tool_wireframe_check").onclick=function(){savePreferences()};add_input_events(document.getElementById("grid_snapping_step"),function(){savePreferences()});add_input_events(document.getElementById("rect_rx"),function(){svgCanvas.setRectRadius(this.value)});add_input_events(document.getElementById("canvas_width"),function(){saveDocProperties()});add_input_events(document.getElementById("canvas_height"),function(){saveDocProperties()});add_input_events(document.getElementById("font_size"),function(){changeFontSize(this)});add_input_events(document.getElementById("group_opacity"),function(){changeOpacity(this.value)});document.getElementById("canvas_title").onchange=saveDocProperties;document.getElementById("resolution").onchange=saveDocProperties;function filterChange(event){svgCanvas.setFilterVal(event.target.value,event.target.getAttribute("data-filterName"),event.target.getAttribute("data-filterProperty"),event.target.getAttribute("data-filterOperator"))}$(".filter").mouseup(filterChange).mousewheel(filterChange).keyup(filterChange);function handleDragSVGOver(e){if(e.preventDefault){e.preventDefault()}if(e.dataTransfer.files.length!=0){e.dataTransfer.dropEffect="move";return false}}function handleDropOpenSVG(e){if(e.stopPropagation){e.stopPropagation()}var file=e.dataTransfer.files[0];var reader=new FileReader();console.log(file);reader.onload=function(event){console.log("event.target.result",event.target.result);if(event.target.result.match(/data:image\/svg/)){console.log("event.target.result.match(/svg$/)");Editor.loadFromDataURI(event.target.result)}};reader.readAsDataURL(file);return false}function handleDragOver(e){if(e.preventDefault){e.preventDefault()}e.dataTransfer.dropEffect="move";return false}function handleDragEnter(e){this.className="over"}function handleDragLeave(e){this.className=""}function handleDrop(drop_event){this.className="";if(drop_event.stopPropagation){drop_event.stopPropagation()}for(var fileIndex in drop_event.dataTransfer.files){var file=drop_event.dataTransfer.files[fileIndex];var reader=new FileReader();console.log(file);reader.onload=function(event){console.log("event.target.result",event.target.result);if(event.target.result.match(/data:image\/(png|jpg|jpeg|gif|tiff)/)){console.log("event.target.result.match(/data:image/(png|jpeg)/)");svgCanvas.addSvgElementFromJson({"element":"image","attr":{"xlink:href":event.target.result,"id":svgCanvas.getNextId(),"x":"20%","y":"20%","width":"60%","height":"60%"}})}else{if(event.target.result.match(/data:image\/svg/)){console.log("event.target.result.match(/svg$/)");var pre="data:image/svg+xml;base64,";var src=event.target.result.substring(pre.length);svgCanvas.importSvgString(svgedit.utilities.decode64(src),true);updateCanvas()}}};reader.readAsDataURL(file)}console.log("e",drop_event);console.log("e.dataTransfer.getData('Text')",drop_event.dataTransfer.getData("Text"));console.log("e.dataTransfer.getData('text/plain')",drop_event.dataTransfer.getData("text/plain"));console.log("e.dataTransfer.getData('URL')",drop_event.dataTransfer.getData("URL"));if(drop_event.dataTransfer.getData("URL").match(/(png|jpg|jpeg|gif|tiff)$/)){console.log("event.target.result.match(/png$/)");svgCanvas.addSvgElementFromJson({"element":"image","attr":{"xlink:href":drop_event.dataTransfer.getData("URL"),"id":svgCanvas.getNextId(),"x":"20%","y":"20%","width":"60%","height":"60%"}})}return false}function handleDragEnd(drop_event){this.className=""}document.getElementById("workarea").addEventListener("dragenter",handleDragEnter,false);document.getElementById("workarea").addEventListener("dragover",handleDragOver,false);document.getElementById("workarea").addEventListener("dragleave",handleDragLeave,false);document.getElementById("workarea").addEventListener("drop",handleDrop,false);document.getElementById("workarea").addEventListener("dragend",handleDragEnd,false);document.getElementById("main_icon").addEventListener("dragover",handleDragSVGOver,false);document.getElementById("main_icon").addEventListener("drop",handleDropOpenSVG,false);function updateSliderZoom(newValue){if(!svgCanvas.isUserDrawing()){document.getElementById("zoom2").value=newValue;changeZoom({value:newValue})}}function updateInputZoom(newValue){if(!svgCanvas.isUserDrawing()){document.getElementById("zoomSlider2").value=Math.sqrt(newValue);changeZoom({value:newValue})}}function zoomDelta(change){if(!svgCanvas.isUserDrawing()){currentZoom=parseInt(document.getElementById("zoom2").value);if(currentZoom+change>0){currentZoom=currentZoom-(currentZoom%change);document.getElementById("zoomSlider2").value=Math.sqrt(currentZoom+change);document.getElementById("zoom2").value=currentZoom+change;changeZoom({value:currentZoom+change})}}}document.getElementById("zoom2").value=svgCanvas.getZoom()*100;document.getElementById("zoom2").onkeyup=function(){updateInputZoom(this.value)};document.getElementById("zoom2").onmouseup=function(){updateInputZoom(this.value)};document.getElementById("zoomIn").onmouseup=function(){zoomDelta(5)};document.getElementById("zoomOut").onmouseup=function(){zoomDelta(-5)};document.getElementById("zoomSlider2").value=Math.sqrt(svgCanvas.getZoom()*100);document.getElementById("zoomSlider2").onchange=function(){updateSliderZoom(Math.pow(this.value,2))};document.getElementById("zoomSlider2").onmouseup=function(){updateSliderZoom(Math.pow(this.value,2))};document.getElementById("zoomSlider2").onmouseup=function(){updateSliderZoom(Math.pow(this.value,2))};var toolFillStyle=document.createElement("style");document.head.appendChild(toolFillStyle);var toolStrokeStyle=document.createElement("style");document.head.appendChild(toolStrokeStyle);updateToolButtonState();$("#workarea").contextMenu({menu:"cmenu_canvas",inSpeed:0},function(action,el,pos){switch(action){case"delete":deleteSelected();break;case"cut":cutSelected();break;case"copy":copySelected();break;case"paste":svgCanvas.pasteElements();break;case"group":svgCanvas.groupSelectedElements();break;case"ungroup":svgCanvas.ungroupSelectedElement();break;case"move_front":moveToTopSelected();break;case"move_up":moveUpDownSelected("Up");break;case"move_down":moveUpDownSelected("Down");break;case"move_back":moveToBottomSelected();break}if(svgCanvas.clipBoard.length){canv_menu.enableContextMenuItems("#paste,#paste_in_place")}});var lmenu_func=function(action,el,pos){switch(action){case"dupe":cloneLayer();break;case"delete":deleteLayer();break;case"merge_down":mergeLayer();break;case"merge_all":svgCanvas.mergeAllLayers();updateContextPanel();populateLayers();break}};$("#layerlist").contextMenu({menu:"cmenu_layers",inSpeed:0},lmenu_func);$("#layer_moreopts").contextMenu({menu:"cmenu_layers",inSpeed:0,allowLeft:true},lmenu_func);$(".contextMenu li").mousedown(function(ev){ev.preventDefault()});$("#cmenu_canvas li").disableContextMenu();canv_menu.enableContextMenuItems("#delete,#cut,#copy");window.onbeforeunload=function(){if(undoMgr.getUndoStackSize()===0){show_save_warning=false}if(!curConfig.no_save_warning&&show_save_warning){return uiStrings.notification.unsavedChanges}};Editor.openPrep=function(func){$("#main_menu").hide();if(undoMgr.getUndoStackSize()===0){func(true)}else{$.confirm(uiStrings.notification.QwantToOpen,func)}};if(window.FileReader){var inp=$('<input type="file">').change(function(){var f=this;Editor.openPrep(function(ok){if(!ok){return}svgCanvas.clear();if(f.files.length==1){var reader=new FileReader();reader.onloadend=function(e){loadSvgString(e.target.result);updateCanvas();zoomChanged(window,"canvas");file_ID=null;cloud_save_as()};reader.readAsText(f.files[0])}})});$("#tool_open").show().prepend(inp);var inp2=$('<input type="file">').change(function(){$("#main_menu").hide();if(this.files.length==1){var reader=new FileReader();reader.onloadend=function(e){console.log("loading...",e.target.result);svgCanvas.importSvgString(e.target.result,true);updateCanvas()};reader.readAsText(this.files[0])}});$("#tool_import").show().prepend(inp2)}var updateCanvas=Editor.updateCanvas=function(center,new_ctr){var w=workarea.width(),h=workarea.height();var w_orig=w,h_orig=h;var zoom=svgCanvas.getZoom();var w_area=workarea;var cnvs=$("#svgcanvas");var old_ctr={x:w_area[0].scrollLeft+w_orig/2,y:w_area[0].scrollTop+h_orig/2};var multi=curConfig.canvas_expansion;w=Math.max(w_orig,svgCanvas.contentW*zoom*multi);h=Math.max(h_orig,svgCanvas.contentH*zoom*multi);if(w==w_orig&&h==h_orig){workarea.css("overflow","hidden")}else{workarea.css("overflow","scroll")}var old_can_y=cnvs.height()/2;var old_can_x=cnvs.width()/2;cnvs.width(w).height(h);var new_can_y=h/2;var new_can_x=w/2;var offset=svgCanvas.updateCanvas(w,h);var ratio=new_can_x/old_can_x;var scroll_x=w/2-w_orig/2;var scroll_y=h/2-h_orig/2;if(!new_ctr){var old_dist_x=old_ctr.x-old_can_x;var new_x=new_can_x+old_dist_x*ratio;var old_dist_y=old_ctr.y-old_can_y;var new_y=new_can_y+old_dist_y*ratio;new_ctr={x:new_x,y:new_y}}else{new_ctr.x+=offset.x,new_ctr.y+=offset.y}if(center){if(svgCanvas.contentW>w_area.width()){workarea[0].scrollLeft=offset.x-10;workarea[0].scrollTop=offset.y-10}else{w_area[0].scrollLeft=scroll_x;w_area[0].scrollTop=scroll_y}}else{w_area[0].scrollLeft=new_ctr.x-w_orig/2;w_area[0].scrollTop=new_ctr.y-h_orig/2}if(curConfig.showRulers){updateRulers(cnvs,zoom);workarea.scroll()}};var r_intervals=[];for(var i=0.1;i<100000;i*=10){r_intervals.push(1*i);r_intervals.push(2*i);r_intervals.push(5*i)}function updateRulers(scanvas,zoom){if(!zoom){zoom=svgCanvas.getZoom()}if(!scanvas){scanvas=$("#svgcanvas")}var limit=30000;var c_elem=svgCanvas.getContentElem();var units=svgedit.units.getTypeMap();var unit=units[curConfig.baseUnit];for(var d=0;d<2;d++){var is_x=(d===0);var dim=is_x?"x":"y";var lentype=is_x?"width":"height";var content_d=c_elem.getAttribute(dim)-0;var $hcanv_orig=$("#ruler_"+dim+" canvas:first");$hcanv=$hcanv_orig.clone();$hcanv_orig.replaceWith($hcanv);var hcanv=$hcanv[0];var ruler_len=scanvas[lentype]();var total_len=ruler_len;hcanv.parentNode.style[lentype]=total_len+"px";var canv_count=1;var ctx_num=0;var ctx_arr;var ctx=hcanv.getContext("2d");ctx.fillStyle="rgb(200,0,0)";ctx.fillRect(0,0,hcanv.width,hcanv.height);$hcanv.siblings().remove();if(ruler_len>=limit){var num=parseInt(ruler_len/limit)+1;ctx_arr=Array(num);ctx_arr[0]=ctx;for(var i=1;i<num;i++){hcanv[lentype]=limit;var copy=hcanv.cloneNode(true);hcanv.parentNode.appendChild(copy);ctx_arr[i]=copy.getContext("2d")}copy[lentype]=ruler_len%limit;ruler_len=limit}hcanv[lentype]=ruler_len;var u_multi=unit*zoom;var raw_m=50/u_multi;var multi=1;for(var i=0;i<r_intervals.length;i++){var num=r_intervals[i];multi=num;if(raw_m<=num){break}}var big_int=multi*u_multi;ctx.font="9px sans-serif";var ruler_d=((content_d/u_multi)%multi)*u_multi;var label_pos=ruler_d-big_int;for(;ruler_d<total_len;ruler_d+=big_int){label_pos+=big_int;var real_d=ruler_d-content_d;var cur_d=Math.round(ruler_d)+0.5;if(is_x){ctx.moveTo(cur_d,15);ctx.lineTo(cur_d,0)}else{ctx.moveTo(15,cur_d);ctx.lineTo(0,cur_d)}var num=(label_pos-content_d)/u_multi;var label;if(multi>=1){label=Math.round(num)}else{var decs=(multi+"").split(".")[1].length;label=num.toFixed(decs)-0}if(label!==0&&label!==1000&&label%1000===0){label=(label/1000)+"K"}if(is_x){ctx.fillText(label,ruler_d+2,8)}else{var str=(label+"").split("");for(var i=0;i<str.length;i++){ctx.fillText(str[i],1,(ruler_d+9)+i*9)}}var part=big_int/10;for(var i=1;i<10;i++){var sub_d=Math.round(ruler_d+part*i)+0.5;if(ctx_arr&&sub_d>ruler_len){ctx_num++;ctx.stroke();if(ctx_num>=ctx_arr.length){i=10;ruler_d=total_len;continue}ctx=ctx_arr[ctx_num];ruler_d-=limit;sub_d=Math.round(ruler_d+part*i)+0.5}var line_num=(i%2)?12:10;if(is_x){ctx.moveTo(sub_d,15);ctx.lineTo(sub_d,line_num)}else{ctx.moveTo(15,sub_d);ctx.lineTo(line_num,sub_d)}}}ctx.strokeStyle="#888";ctx.stroke()}}updateCanvas(true);updateTitle("untitled");svgCanvas.setDocumentTitle("untitled");zoomChanged(window,"canvas");try{var json_encode=function(obj){if(window.JSON&&JSON.stringify){return JSON.stringify(obj)}var enc=arguments.callee;if(typeof obj=="boolean"||typeof obj=="number"){return obj+""}else{if(typeof obj=="string"){return'"'+obj.replace(/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}else{if(obj.length){for(var i=0;i<obj.length;i++){obj[i]=enc(obj[i])}return"["+obj.join(",")+"]"}else{var pairs=[];for(var k in obj){pairs.push(enc(k)+":"+enc(obj[k]))}return"{"+pairs.join(",")+"}"}}}};window.addEventListener("message",function(e){var cbid=parseInt(e.data.substr(0,e.data.indexOf(";")));try{e.source.postMessage("SVGe"+cbid+";"+json_encode(eval(e.data)),"*")}catch(err){e.source.postMessage("SVGe"+cbid+";error:"+err.message,"*")}},false)}catch(err){window.embed_error=err}$(function(){window.svgCanvas=svgCanvas;svgCanvas.ready=Editor.ready})};var callbacks=[];function loadSvgString(str,callback){var success=svgCanvas.setSvgString(str)!==false;callback=callback||$.noop;if(success){callback(true)}else{$.alert(uiStrings.notification.errorLoadingSVG,function(){callback(false)})}}Editor.ready=function(cb){if(!is_ready){callbacks.push(cb)}else{cb()}};Editor.runCallbacks=function(){$.each(callbacks,function(){this()});is_ready=true};Editor.loadFromString=function(str){Editor.ready(function(){loadSvgString(str)})};Editor.loadFromURL=function(url,opts){console.log("open "+url);if(!opts){opts={}}var cache=opts.cache;var cb=opts.callback;Editor.ready(function(){$.get({"url":url,"dataType":"text",cache:!!cache,success:function(str){console.log("Loading SVG string");loadSvgString(str,cb)},error:function(xhr,stat,err){console.log("Loading Failted "+xhr.status+xhr.responseText);if(xhr.status!=404&&xhr.responseText){loadSvgString(xhr.responseText,cb)}else{$.alert(uiStrings.notification.URLloadFail+": \n"+err+"",cb)}}})})};Editor.loadFromDataURI=function(str){Editor.ready(function(){var pre="data:image/svg+xml;base64,";var src=str.substring(pre.length);loadSvgString(svgedit.utilities.decode64(src))})};window["svgEditorAddExtension"]=function(){var args=arguments;$(function(){if(svgCanvas){svgCanvas.addExtension.apply(this,args)}})};return Editor}(jQuery)}$(svgEditor.init)})();